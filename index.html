<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
 <title>Zevi Character Sheet</title>
 <link rel="stylesheet" href="style.css">
</head>
<body>
 <div class="glass" data-color-target="main-glass">
  <header>
   <div class="char-img-wrapper">
    <div class="char-img-border" data-color-target="char-image-border"></div>
    <img src="" alt="Character Portrait" id="charImage" onclick="document.getElementById('charUpload').click();">
    <div class="placeholder" id="charPlaceholder">Click to add character image</div>
    <input type="file" id="charUpload" accept="image/*" style="display:none;" onchange="uploadCharacterImage(event)">
   </div>

   <div class="name-box" data-color-target="name-box">
    <input type="text" id="characterName" value="Character Name" onblur="saveCharacterField('name', this.value)" onchange="saveCharacterField('name', this.value)" />
    <div class="subtitle" id="characterSubtitle" contenteditable="true" onblur="saveCharacterField('subtitle', this.textContent)" onkeyup="saveCharacterField('subtitle', this.textContent)">Community Ancestry Class (Subclass)</div>
    <div class="domain-row">
     <span class="domain-badge" id="domain1" contenteditable="true" onblur="saveCharacterField('domain1', this.textContent)" onkeyup="saveCharacterField('domain1', this.textContent)">Domain 1</span>
     <span class="domain-divider">||</span>
     <span class="level-display" id="charLevel" contenteditable="true" onblur="saveCharacterField('level', this.textContent)" onkeyup="saveCharacterField('level', this.textContent)">5</span>
     <span class="domain-divider">||</span>
     <span class="domain-badge" id="domain2" contenteditable="true" onblur="saveCharacterField('domain2', this.textContent)" onkeyup="saveCharacterField('domain2', this.textContent)">Domain 2</span>
    </div>
    
    <div class="hope-tracker-inline">
     <h4>Hope</h4>
     <div class="trackers-wrapper">
      <div class="tracker-btn" id="hope-decrement">-</div>
      <div class="trackers" id="hope-tracker">
       </div>
      <div class="tracker-btn" id="hope-increment">+</div>
     </div>
     <div id="encumbrance-warning-main" class="encumbrance-warning" style="display: none; margin-top: 10px; font-size: 0.8rem;">
      ‚ö†Ô∏è You are over-encumbered! -2 to strength & agility checks
     </div>
    </div>
   </div>

   <div class="right-info">
    <span id="toggleTheme" style="cursor: pointer;">üåô</span>
   </div>
   
   <div class="header-bottom-center">
    <a href="https://drive.google.com/file/d/1KPD_jt2jaNn2Okd9dDbQNRVdk5PAk2R2/view?usp=drivesdk" target="_blank" class="rulebook-link">Official Rulebook</a>
   </div>
  </header>

  <div class="divider"></div>

  <div class="flex-row" id="draggable-sections">
   <div class="column section" data-id="ability" data-color-target="ability-scores">
    <h3>Ability Scores</h3>
    <div class="attributes-grid">
     <div class="attribute-box">
      <h4>Agility</h4>
      <input type="number" class="attribute-value" data-attribute="agility" value="0">
      <p class="attribute-text">Sprint || Dodge || Leap</p>
     </div>
     <div class="attribute-box">
      <h4>Strength</h4>
      <input type="number" class="attribute-value" data-attribute="strength" value="0">
      <p class="attribute-text">Lift || Smash || Grapple</p>
     </div>
     <div class="attribute-box">
      <h4>Finesse</h4>
      <input type="number" class="attribute-value" data-attribute="finesse" value="0">
      <p class="attribute-text">Control || Hide || Tinker</p>
     </div>
     <div class="attribute-box">
      <h4>Instinct</h4>
      <input type="number" class="attribute-value" data-attribute="instinct" value="0">
      <p class="attribute-text">Perceive || Sense || Navigate</p>
     </div>
     <div class="attribute-box">
      <h4>Presence</h4>
      <input type="number" class="attribute-value" data-attribute="presence" value="0">
      <p class="attribute-text">Charm || Perform || Deceive</p>
     </div>
     <div class="attribute-box">
      <h4>Knowledge</h4>
      <input type="number" class="attribute-value" data-attribute="knowledge" value="0">
      <p class="attribute-text">Recall || Analyze || Comprehend</p>
     </div>
    </div>
    <div class="evasion-display">
     <div class="evasion-label">Evasion</div>
     <input type="number" class="evasion-value" id="evasionValue" value="10" contenteditable="true">
    </div>
   </div>
   <div class="column section" data-id="hp" data-color-target="hp-stress">
    <h3>Hit Points & Stress</h3>
    <div class="damage-control-row">
     <button class="damage-btn" id="minor-damage-btn">
      <span>Minor</span>
      <span>Damage</span>
     </button>
     <input type="number" class="damage-value-input" id="minor-damage-value" min="0" onchange="window.updateDamageValue(this, 'minor')">

     <button class="damage-btn" id="major-damage-btn">
      <span>Major</span>
      <span>Damage</span>
     </button>
     <input type="number" class="damage-value-input" id="major-damage-value" min="0" onchange="window.updateDamageValue(this, 'major')">

     <button class="damage-btn" id="severe-damage-btn">
      <span>Severe</span>
      <span>Damage</span>
     </button>
    </div>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-hp">-</button>
     <div class="trackers" id="hp-tracker">
      </div>
     <button class="tracker-btn add-hp">+</button>
    </div>
    <div class="divider"></div>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-stress">-</button>
     <div class="trackers" id="stress-tracker">
      </div>
     <button class="tracker-btn add-stress">+</button>
    </div>
   </div>
   <div class="column section" data-id="weapons" data-color-target="active-weapons">
    <h3>Active Weapons</h3>
   </div>
   <div class="column section" data-id="armor" data-color-target="armor-section">
    <h3>Armor</h3>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-armor">-</button>
     <div class="trackers" id="armor-tracker">
      </div>
     <button class="tracker-btn add-armor">+</button>
    </div>

   </div>
  </div>

  <div class="divider"></div>

  <nav class="tabs">
   <button data-target="domain-vault-tab-content">Domain Vault</button>
   <button data-target="effects-features-tab-content">Effects & Features</button>
   <button data-target="equipment-tab-content">Equipment</button>
   <button data-target="details-tab-content">Details</button>
   <button data-target="experiences-tab-content">Experiences</button>
   <button data-target="journal-tab-content">Journal</button>
   <button data-target="downtime-tab-content" class="active">Downtime</button>
   <button data-target="characters-tab-content">Characters</button>
   <button data-target="settings-tab-content">Settings</button>
  </nav>

  <div class="divider"></div>

  <div class="tab-content-area">
   <div id="domain-vault-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Domain Vault will go here.</p>
   </div>
   <div id="effects-features-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Effects & Features will go here.</p>
   </div>
   <div id="equipment-tab-content" class="tab-panel">
    <!-- Equipment content will be populated by equipment.js -->
   </div>
   <div id="details-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Details will go here.</p>
   </div>
   <div id="experiences-tab-content" class="tab-panel">
    <button id="show-create-experience-modal-btn" class="button" onclick="window.showCreateExperienceModal()">Create New Experience</button>
    <div id="experiences-list-container" class="experiences-list-container">
    </div>

    <div id="experience-detail-container" class="experience-detail-container" style="display: none;">
     <h4 id="detail-experience-title"></h4>
     <p id="detail-experience-description"></p>
     <p>Modifier: <input type="number" id="detail-experience-modifier" class="mini-input" min="-2" max="2" onchange="window.updateExperienceModifier(this)"></p>
     <button class="button" onclick="window.closeExperienceDetail()">Back to Experiences</button>
    </div>
   </div>
   <div id="journal-tab-content" class="tab-panel">
    <div class="journal-category-buttons">
     <button class="button active" data-journal-category="all">All Entries</button>
     <button class="button" data-journal-category="downtime">Downtime</button>
     <button class="button" data-journal-category="combat">Combat</button>
     <button class="button" data-journal-category="exploration">Exploration</button>
     <button class="button" data-journal-category="social">Social</button>
     <button class="button" data-journal-category="other">Other</button>
    </div>
    <div id="journal-entries-list" class="journal-entries-list">
    </div>
    <div id="journal-entry-detail" class="journal-entry-detail" style="display: none;">
     <div class="journal-detail-header">
      <h4 id="journal-detail-title"></h4>
      <span id="journal-detail-date"></span>
      <span id="journal-detail-category"></span>
     </div>
     <div id="journal-detail-content" class="journal-detail-content"></div>
     <button class="button" onclick="window.closeJournalDetail()">Back to Entries</button>
    </div>
    <button class="button" onclick="window.showJournalEntryModal()">Add New Entry</button>
   </div>

   <div id="downtime-tab-content" class="tab-panel active">
    <div id="rest-type-selector">
     <h2>Choose Rest Type</h2>
     <div class="button-group">
      <button class="button" onclick="window.startRest('short')">Short Rest (1 Hour)</button>
      <button class="button" onclick="window.startRest('long')">Long Rest (6 Hours)</button>
     </div>
    </div>

    <div id="rest-options-container" style="display: none;">
     <h3 id="rest-title"></h3>
     <div class="gm-notification" id="gm-notification"></div>
     <div class="notification-area" id="downtime-notification-area"></div>
     <div id="rest-options-list" class="rest-options-list">
      </div>
     <button class="button" onclick="window.confirmRest()">Confirm Rest</button>
     <button class="button" onclick="window.resetDowntimeView()">Cancel Rest</button>

     <div id="long-rest-projects-container" class="long-term-projects" style="display: none;">
      <div class="projects-header">
       <h4>Long-Term Projects</h4>
       <div class="project-action-buttons">
        <button class="button" onclick="window.showCompletedProjects()">View Completed Projects</button>
        <button class="button" onclick="window.showActiveProjects()">View Active Projects</button>
        <button class="button" onclick="window.showCreateNewProject()">Create New Project</button>
       </div>
      </div>
      <div id="project-view-area">
       <div id="completed-projects-view" style="display: none;">
        <h5>Completed Projects</h5>
        <div id="completed-projects-list"></div>
       </div>
       <div id="active-projects-view" style="display: none;">
        <h5>Active Projects - Select one to advance</h5>
        <div id="active-projects-list"></div>
        <div id="selected-project-info" style="display: none;">
         <p>Selected: <span id="selected-project-name"></span></p>
        </div>
       </div>
       <div id="create-project-view" style="display: none;">
        <h5>Create New Project</h5>
        <input type="text" id="new-project-name" placeholder="Project Name">
        <label for="new-project-segments">Number of segments (1-12):</label>
        <input type="number" id="new-project-segments" min="1" max="12" value="4">
        <div class="modal-buttons">
         <button class="button" onclick="window.createNewProject()">Create Project</button>
         <button class="button" onclick="window.hideProjectViews()">Cancel</button>
        </div>
       </div>
      </div>
     </div>

     <div id="rest-summary-area" class="rest-summary-area" style="display: none;">
      <h4>Rest Summary</h4>
      <ul id="rest-summary-list">
       </ul>
      <button class="button" onclick="window.acknowledgeRest()">Okay</button>
     </div>
    </div>
   </div>

   <div id="characters-tab-content" class="tab-panel">
    <div class="character-management-container">
     <h2>Character Management</h2>
     <div class="character-actions">
      <button class="option-btn primary-btn" onclick="createNewCharacter()">Create New Character</button>
     </div>
     <div id="current-character-info" class="current-character-info">
      <!-- Current character info will be populated here -->
     </div>
     <div id="character-list-section" class="character-list-section">
      <h3>Available Characters</h3>
      <div id="character-list-container" class="character-list-container">
       <!-- Character list will be populated here -->
      </div>
     </div>
    </div>
   </div>
   <div id="settings-tab-content" class="tab-panel">
    <div class="settings-container">
     <h2>Settings</h2>
     
     <!-- Accent Color Theme Section -->
     <div class="settings-section">
      <h3>Accent Color Theme</h3>
      <p>Change the color of accent elements (currently yellow) throughout the character sheet.</p>
      <div class="color-control">
       <label for="accentColorPicker">Accent Color:</label>
       <div class="color-picker-group">
        <input type="color" id="accentColorPicker" value="#ffd700">
        <div class="color-preview" id="accentColorPreview"></div>
        <button type="button" id="resetAccentColor" class="reset-btn">Reset to Default</button>
       </div>
      </div>
     </div>
     
     <!-- Glassmorphic Background Tint Section -->
     <div class="settings-section">
      <h3>Glassmorphic Background Tint</h3>
      <p>Customize the color and opacity of the glassmorphic background effect.</p>
      <div class="color-control">
       <label for="glassColorPicker">Glass Tint Color:</label>
       <div class="color-picker-group">
        <input type="color" id="glassColorPicker" value="#ffffff">
        <div class="color-preview glass-preview" id="glassColorPreview"></div>
        <button type="button" id="resetGlassColor" class="reset-btn">Reset to Default</button>
       </div>
      </div>
      <div class="slider-control">
       <label for="glassOpacitySlider">Glass Opacity:</label>
       <div class="slider-group">
        <input type="range" id="glassOpacitySlider" min="5" max="30" value="10" step="1">
        <span id="glassOpacityValue">10%</span>
       </div>
      </div>
     </div>
     
     <!-- Background Image Section -->
     <div class="settings-section">
      <h3>Background Image</h3>
      <p>Upload a custom background image for your character sheet.</p>
      <div class="file-upload-control">
       <label for="bgUpload" class="file-upload-label">
        <span class="upload-icon">üèûÔ∏è</span>
        <span class="upload-text">Choose Background Image</span>
       </label>
       <input type="file" id="bgUpload" accept="image/*" onchange="uploadBackground(event)" class="file-upload-input">
      </div>
     </div>
     
     <!-- Character Code Section -->
     <div class="settings-section">
      <h3>Character Code</h3>
      <p>A unique code representing your character's current state. Share this code to let others import your character.</p>
      <div class="character-code-control">
       <div class="code-display-group">
        <label for="characterCodeDisplay">Your Character Code:</label>
        <div class="code-display">
         <input type="text" id="characterCodeDisplay" readonly value="YWSAFHB">
         <button type="button" id="copyCodeBtn" class="copy-btn" title="Copy to clipboard">üìã</button>
        </div>
       </div>
       <div class="code-actions">
        <button type="button" id="generateCodeBtn" class="action-btn">Generate New Code</button>
        <button type="button" id="importCodeBtn" class="action-btn">Import Character</button>
       </div>
      </div>
     </div>
     
     <!-- Backpack & Encumbrance Toggle Section -->
     <div class="settings-section">
      <h3>Equipment Features</h3>
      <p>Toggle advanced equipment features like backpack selection, encumbrance tracking, and additional equipment slots.</p>
      <div class="toggle-control">
       <label for="backpackToggle" class="toggle-label">
        <input type="checkbox" id="backpackToggle" checked>
        <span class="toggle-slider"></span>
        <span class="toggle-text">Enable Backpack & Encumbrance System</span>
       </label>
       <div class="toggle-description">
        <p><strong>When enabled:</strong> Backpack selection, encumbrance tracking, attire slots, and belt/consumables slots are available.</p>
        <p><strong>When disabled:</strong> Simplified equipment view with only combat equipment and inventory management.</p>
       </div>
      </div>
     </div>
     
     <!-- Character Deletion Section -->
     <div class="settings-section danger-section">
      <h3>Character Data</h3>
      <p>Delete all character information and return to a fresh character sheet.</p>
      <button type="button" id="deleteCharacterBtn" class="danger-btn">Delete Character</button>
     </div>
     
     <!-- Account Deletion Section -->
     <div class="settings-section danger-section">
      <h3>Account Data</h3>
      <p>Delete all account data including character information and settings.</p>
      <button type="button" id="deleteAccountBtn" class="danger-btn">Delete Account</button>
     </div>
    </div>
   </div>
   
   <!-- Character Delete Modal -->
   <div id="characterDeleteModal" class="modal">
    <div class="modal-content">
     <h3>Delete Character</h3>
     <p>Are you sure you want to delete all character data? This action cannot be undone.</p>
     <div class="modal-buttons">
      <button type="button" id="confirmCharacterDelete" class="confirm-delete-btn">Confirm Character Delete</button>
      <button type="button" id="cancelCharacterDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>
   
   <!-- Account Delete Modal -->
   <div id="accountDeleteModal" class="modal">
    <div class="modal-content">
     <h3>Delete Account</h3>
     <p>Are you sure you want to delete your entire account? This will remove all data and cannot be undone.</p>
     <div class="modal-buttons">
      <button type="button" id="confirmAccountDelete" class="confirm-delete-btn">Confirm Account Delete</button>
      <button type="button" id="cancelAccountDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>

   <!-- Character Import Modal -->
   <div id="characterImportModal" class="modal">
    <div class="modal-content">
     <h3>Import Character</h3>
     <p>Enter a character code to import character data:</p>
     <input type="text" id="importCodeInput" placeholder="Enter character code (e.g. YWSAFHB)" style="width: 100%; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
     <div class="modal-buttons">
      <button type="button" id="confirmCharacterImport" class="confirm-btn">Import Character</button>
      <button type="button" id="cancelCharacterImport" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>

  </div>
 </div>



 <div id="journal-entry-modal" class="modal-overlay">
    <div class="modal">
        <h3>New Journal Entry</h3>
        <input type="text" id="journal-entry-title-input" placeholder="Entry Title (e.g., Encounter with Goblins)">
        <select id="journal-entry-category-select">
            <option value="downtime">Downtime</option>
            <option value="combat">Combat</option>
            <option value="exploration">Exploration</option>
            <option value="social">Social</option>
            <option value="other">Other</option>
        </select>
        <textarea id="journal-entry-content-input" placeholder="What happened?"></textarea>
        <div class="modal-buttons">
            <button class="button" onclick="window.saveJournalEntry()">Save Entry</button>
            <button class="button" onclick="window.closeJournalEntryModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="prepare-choice-modal" class="modal-overlay">
    <div class="modal glassmorphic">
        <h3>Prepare</h3>
        <p>Are you preparing with a party member?</p>
        <div class="modal-buttons">
            <button class="button" onclick="window.handlePrepareWithParty(true)">Yes (Gain 2 Hope)</button>
            <button class="button" onclick="window.handlePrepareWithParty(false)">No (Gain 1 Hope)</button>
        </div>
    </div>
</div>

<div id="create-experience-modal" class="modal-overlay">
    <div class="modal">
        <h3>Create New Experience</h3>
        <input type="text" id="experience-title-input" placeholder="Experience Title">
        <textarea id="experience-description-input" placeholder="Describe this experience..."></textarea>
        <label for="experience-modifier-input">Modifier (-2 to +2):</label>
        <input type="number" id="experience-modifier-input" value="0" min="-2" max="2">
        <div class="modal-buttons">
            <button class="button" onclick="window.saveNewExperience()">Save Experience</button>
            <button class="button" onclick="window.closeCreateExperienceModal()">Cancel</button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
 <script src="hpStress.js"></script>
 <script src="hope.js"></script>
 <script src="script.js"></script>
 <script src="downtime.js"></script>
 <script src="journal.js"></script>
 <script src="experiences.js"></script>
 <script src="details.js"></script>
 <script src="settings.js"></script>
 <script src="equipment.js"></script>
 <script src="characterManager.js"></script>
 <script>
  // Initialize character management
  
    // Auto-save character data periodically
  setInterval(() => {
    if (window.characterManager && window.characterManager.currentCharacter) {
      window.characterManager.saveCharacterData(window.characterManager.currentCharacter);
    }
  }, 30000); // Save every 30 seconds
  
  // Check if we're supposed to load a character (coming from character selection)
  document.addEventListener('DOMContentLoaded', () => {
    const currentCharacterId = localStorage.getItem('zevi-current-character-id');
    const isDirectAccess = !document.referrer || !document.referrer.includes('landing.html');
    
    // If no character ID or direct access, redirect to landing page
    if (!currentCharacterId || isDirectAccess) {
      console.log('No character ID or direct access, redirecting to landing page');
      window.location.href = 'landing.html';
      return;
    }
    
    // We have a character ID and came from landing page, initialize character
    initializeCharacterFromId(currentCharacterId);
  });
  
  function initializeCharacterFromId(characterId) {
    const waitForCharacterManager = (attempts = 0) => {
      if (attempts > 50) {
        console.warn('Character manager failed to load, redirecting to landing page');
        localStorage.removeItem('zevi-current-character-id');
        window.location.href = 'landing.html';
        return;
      }
      
      if (window.characterManager) {
        try {
          const character = window.characterManager.getCharacter(characterId);
          if (character) {
            window.characterManager.currentCharacter = character;
            
            // Load character data into the UI
            loadCharacterIntoUI(character);
            
            // Initialize Characters tab
            setTimeout(initializeCharactersTab, 100);
            
            // Clear any creating character flag
            localStorage.removeItem('zevi-creating-character');
            
            console.log('Character loaded successfully:', character.name);
          } else {
            console.warn('Character not found, redirecting to landing page');
            localStorage.removeItem('zevi-current-character-id');
            window.location.href = 'landing.html';
          }
        } catch (error) {
          console.error('Error loading character:', error);
          localStorage.removeItem('zevi-current-character-id');
          window.location.href = 'landing.html';
        }
      } else {
        setTimeout(() => waitForCharacterManager(attempts + 1), 50);
      }
    };
    
    waitForCharacterManager();
  }
  
  // Load character data into the UI elements
  function loadCharacterIntoUI(character) {
    // Load basic character info
    const nameInput = document.getElementById('characterName');
    const subtitleDiv = document.getElementById('characterSubtitle');
    const levelSpan = document.getElementById('charLevel');
    const domain1Span = document.getElementById('domain1');
    const domain2Span = document.getElementById('domain2');
    
    if (nameInput) nameInput.value = character.name || 'Character Name';
    if (subtitleDiv) subtitleDiv.textContent = character.subtitle || 'Community Ancestry Class (Subclass)';
    if (levelSpan) levelSpan.textContent = character.level || '5';
    if (domain1Span) domain1Span.textContent = character.domain1 || 'Domain 1';
    if (domain2Span) domain2Span.textContent = character.domain2 || 'Domain 2';
    
    // Load character image
    if (character.characterImage) {
      const img = document.getElementById("charImage");
      const placeholder = document.getElementById("charPlaceholder");
      if (img && placeholder) {
        img.src = character.characterImage;
        placeholder.style.display = 'none';
      }
    } else {
      const img = document.getElementById("charImage");
      const placeholder = document.getElementById("charPlaceholder");
      if (img && placeholder) {
        img.src = '';
        placeholder.style.display = 'block';
      }
    }
    
    // Load HP data
    if (character.hp && window.hpCircles !== undefined) {
      // Update global hpCircles array
      const maxHP = character.hp.max || 4;
      const currentHP = character.hp.current || 0;
      window.hpCircles = Array(maxHP).fill(null).map((_, i) => ({ active: i < currentHP }));
      localStorage.setItem('zevi-hp-circles', JSON.stringify(window.hpCircles));
      if (typeof renderHPCircles === 'function') renderHPCircles();
    }
    
    // Load Stress data
    if (character.stress && window.stressCircles !== undefined) {
      const maxStress = character.stress.max || 4;
      const currentStress = character.stress.current || 0;
      window.stressCircles = Array(maxStress).fill(null).map((_, i) => ({ active: i < currentStress }));
      localStorage.setItem('zevi-stress-circles', JSON.stringify(window.stressCircles));
      if (typeof renderStressCircles === 'function') renderStressCircles();
    }
    
    // Load Hope data
    if (character.hope) {
      const currentHope = character.hope.current || 0;
      const maxHope = character.hope.max || 6;
      localStorage.setItem('zevi-hope', currentHope);
      localStorage.setItem('zevi-max-hope', maxHope);
      if (typeof renderHopeCircles === 'function') renderHopeCircles();
    }
  }
  
  // Save character field when it changes
  function saveCharacterField(fieldName, value) {
    if (window.characterManager && window.characterManager.currentCharacter) {
      const character = window.characterManager.currentCharacter;
      
      // Update the character object
      switch(fieldName) {
        case 'name':
          character.name = value;
          break;
        case 'subtitle':
          character.subtitle = value;
          break;
        case 'level':
          character.level = parseInt(value) || 1;
          break;
        case 'domain1':
          character.domain1 = value;
          break;
        case 'domain2':
          character.domain2 = value;
          break;
      }
      
      // Update the last modified time
      character.lastModified = new Date().toISOString();
      
      // Save to localStorage
      window.characterManager.updateCharacterMetadata(character.id, {
        [fieldName]: value,
        lastModified: character.lastModified
      });
      
             // Update Characters tab in real-time
       setTimeout(window.initializeCharactersTab, 10);
      
      console.log(`Updated character ${fieldName}:`, value);
    }
  }
   
   // Initialize Characters tab content
   function initializeCharactersTab() {
     if (window.characterManager) {
       // Show current character info
       if (window.characterManager.currentCharacter) {
         const character = window.characterManager.currentCharacter;
         const infoDiv = document.getElementById('current-character-info');
         if (infoDiv) {
           const layoutInfo = character.layout === 'dnd' ? 
             { name: 'D&D 5e', icon: 'üêâ' } : 
             { name: 'Daggerheart', icon: '‚öîÔ∏è' };
           
           infoDiv.innerHTML = `
             <div class="current-character-card">
               <h3>Current Character</h3>
               ${character.characterImage ? 
                 `<div class="character-image-display">
                    <img src="${character.characterImage}" alt="${character.name}" class="character-display-image">
                  </div>` : 
                 `<div class="character-image-placeholder">
                    <span class="image-placeholder-icon">üë§</span>
                  </div>`
               }
               <div class="character-info">
                 <h4>${character.name}</h4>
                 ${character.subtitle ? `<p class="character-subtitle">${character.subtitle}</p>` : ''}
                 <p class="character-level">Level: ${character.level}</p>
                 <p class="character-system">
                   <span class="system-icon">${layoutInfo.icon}</span>
                   System: ${layoutInfo.name}
                 </p>
                 <p class="character-dates">
                   <small>Created: ${window.characterManager.formatDate ? window.characterManager.formatDate(character.createdAt) : character.createdAt}</small><br>
                   <small>Last Modified: ${window.characterManager.formatDate ? window.characterManager.formatDate(character.lastModified) : character.lastModified}</small>
                 </p>
               </div>
             </div>
           `;
         }
       }
       
       // Show all available characters
       const listContainer = document.getElementById('character-list-container');
       if (listContainer && window.characterManager.characters) {
         if (window.characterManager.characters.length === 0) {
           listContainer.innerHTML = '<p class="no-characters">No characters found. Create your first character!</p>';
         } else {
           listContainer.innerHTML = window.characterManager.characters.map(character => {
             const layoutInfo = character.layout === 'dnd' ? 
               { name: 'D&D 5e', icon: 'üêâ', class: 'dnd-layout' } : 
               { name: 'Daggerheart', icon: '‚öîÔ∏è', class: 'daggerheart-layout' };
             
             const isCurrentCharacter = window.characterManager.currentCharacter && 
                                      window.characterManager.currentCharacter.id === character.id;
             
             return `
               <div class="character-list-card ${isCurrentCharacter ? 'current-character' : ''}" data-character-id="${character.id}">
                 ${character.characterImage ? 
                   `<div class="character-list-image">
                      <img src="${character.characterImage}" alt="${character.name}" class="character-list-thumbnail">
                    </div>` : 
                   `<div class="character-list-placeholder">
                      <span class="list-placeholder-icon">üë§</span>
                    </div>`
                 }
                 <div class="character-list-info">
                   <h4>${character.name}</h4>
                   ${character.subtitle ? `<p class="character-list-subtitle">${character.subtitle}</p>` : ''}
                   <p class="character-list-level">Level: ${character.level}</p>
                   <p class="character-list-system ${layoutInfo.class}">
                     <span class="system-icon">${layoutInfo.icon}</span>
                     ${layoutInfo.name}
                   </p>
                 </div>
                 <div class="character-list-actions">
                   ${isCurrentCharacter ? 
                     '<span class="current-indicator">Current</span>' : 
                     `<button class="load-character-btn" onclick="loadCharacterFromTab('${character.id}')">Load</button>`
                   }
                   <button class="delete-character-btn" onclick="deleteCharacterFromTab('${character.id}', '${character.name}')">Delete</button>
                 </div>
               </div>
             `;
           }).join('');
         }
       }
     }
   }
   
   // Make function globally available
   window.initializeCharactersTab = initializeCharactersTab;
   
   // Load character from Characters tab
   function loadCharacterFromTab(characterId) {
     if (window.characterManager) {
       const character = window.characterManager.getCharacter(characterId);
       if (character) {
         // Save current character data first
         if (window.characterManager.currentCharacter) {
           window.characterManager.saveCharacterData(window.characterManager.currentCharacter);
         }
         
         // Load the selected character
         if (window.characterManager.loadCharacterData(character)) {
           // Redirect based on character's layout
           const layout = character.layout || 'daggerheart';
           if (layout === 'dnd') {
             window.location.href = 'dnd-placeholder.html';
           } else {
             window.location.href = 'index.html';
           }
         } else {
           alert('Error loading character data. Please try again.');
         }
       } else {
         alert('Character not found!');
       }
     }
   }
   
   // Delete character from Characters tab
   function deleteCharacterFromTab(characterId, characterName) {
     if (confirm(`Are you sure you want to delete "${characterName}"? This action cannot be undone.`)) {
       if (window.characterManager) {
         window.characterManager.deleteCharacter(characterId);
         // Refresh the Characters tab
         initializeCharactersTab();
         
         // If we deleted the current character, clear the current character
         if (window.characterManager.currentCharacter && window.characterManager.currentCharacter.id === characterId) {
           localStorage.removeItem('zevi-current-character-id');
           window.location.href = 'landing.html';
         }
       }
     }
   }
   
   // Add tab click listeners to initialize Characters tab when clicked
   document.addEventListener('DOMContentLoaded', () => {
     const charactersTabBtn = document.querySelector('[data-target="characters-tab-content"]');
     if (charactersTabBtn) {
       charactersTabBtn.addEventListener('click', () => {
         setTimeout(initializeCharactersTab, 100); // Small delay to ensure tab is active
       });
     }
   });
 </script>
</html>
