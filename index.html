<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zevi Character Sheet</title>
    <!-- Cache bust: v2.0 - 2025-07-30 -->
    <link rel="stylesheet" href="assets/css/main.css">
    <!-- API and Authentication Scripts -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
</head>
<body>
 <div class="glass" data-color-target="main-glass">
  <header>
   <div class="char-img-wrapper" onclick="document.getElementById('charUpload').click();">
    <div class="char-img-border" data-color-target="char-image-border"></div>
    <img src="" alt="Character Portrait" id="charImage">
    <div class="placeholder" id="charPlaceholder">Click to add character image</div>
    <input type="file" id="charUpload" accept="image/*" style="display:none;" onchange="uploadCharacterImage(event)">
   </div>

               <div class="name-box" data-color-target="name-box">
                <div class="character-name-editor" contenteditable="true" data-placeholder="Character Name">Character Name</div>
                <div class="subtitle" contenteditable="true">Community Ancestry Class (Subclass)</div>
    <div class="domain-row">
     <span class="domain-badge" contenteditable="true">Domain 1</span>
     <span class="domain-divider">||</span>
     <span class="level-display" id="charLevel" contenteditable="true">5</span>
     <span class="domain-divider">||</span>
     <span class="domain-badge" contenteditable="true">Domain 2</span>
    </div>
    
    <div class="hope-tracker-inline">
     <h4>Hope</h4>
     <div class="trackers-wrapper">
      <div class="tracker-btn" id="hope-decrement">-</div>
      <div class="trackers" id="hope-tracker">
       </div>
      <div class="tracker-btn" id="hope-increment">+</div>
     </div>
     <div id="encumbrance-warning-main" class="encumbrance-warning" style="display: none; margin-top: 10px; font-size: 0.8rem;"></div>
    </div>
   </div>

   <div class="right-info">
    <span id="toggleTheme" style="cursor: pointer;">üåô</span><br />
   </div>

   <!-- Simple Save Character Button -->
   <div class="save-button-container" style="text-align: center; margin: 15px 0;">
    <button id="save-character-btn" class="save-character-btn" onclick="saveCharacter()">
     üíæ Save Character
    </button>
    <br>
    <button onclick="debugCurrentCharacter()" style="margin-top: 10px; padding: 5px 10px; background: #666; color: white; border: none; border-radius: 4px; font-size: 0.8rem;">
     üîç Check Character Sheet
    </button>
   </div>
   
   <div class="header-bottom-center">
    <a href="https://drive.google.com/file/d/1KPD_jt2jaNn2Okd9dDbQNRVdk5PAk2R2/view?usp=drivesdk" target="_blank" class="rulebook-link">Official Rulebook</a>
   </div>
  </header>

  <div class="divider"></div>

  <div class="flex-row" id="draggable-sections">
   <div class="column section" data-id="ability" data-color-target="ability-scores">
    <h3>Ability Scores</h3>
    <div class="attributes-grid">
     <div class="attribute-box">
      <h4>Agility</h4>
      <input type="number" class="attribute-value" data-attribute="agility" value="0">
      <p class="attribute-text">Sprint || Dodge || Leap</p>
     </div>
     <div class="attribute-box">
      <h4>Strength</h4>
      <input type="number" class="attribute-value" data-attribute="strength" value="0">
      <p class="attribute-text">Lift || Smash || Grapple</p>
     </div>
     <div class="attribute-box">
      <h4>Finesse</h4>
      <input type="number" class="attribute-value" data-attribute="finesse" value="0">
      <p class="attribute-text">Control || Hide || Tinker</p>
     </div>
     <div class="attribute-box">
      <h4>Instinct</h4>
      <input type="number" class="attribute-value" data-attribute="instinct" value="0">
      <p class="attribute-text">Perceive || Sense || Navigate</p>
     </div>
     <div class="attribute-box">
      <h4>Presence</h4>
      <input type="number" class="attribute-value" data-attribute="presence" value="0">
      <p class="attribute-text">Charm || Perform || Deceive</p>
     </div>
     <div class="attribute-box">
      <h4>Knowledge</h4>
      <input type="number" class="attribute-value" data-attribute="knowledge" value="0">
      <p class="attribute-text">Recall || Analyze || Comprehend</p>
     </div>
    </div>
    <div class="evasion-display">
     <div class="evasion-label">Evasion</div>
     <input type="number" class="evasion-value" id="evasionValue" value="10" contenteditable="true">
    </div>
   </div>
   <div class="column section" data-id="hp" data-color-target="hp-stress">
    <h3>Hit Points & Stress</h3>
    <div class="damage-control-row">
     <button class="damage-btn" id="minor-damage-btn">
      <span>Minor</span>
      <span>Damage</span>
     </button>
     <input type="number" class="damage-value-input" id="minor-damage-value" min="0" onchange="window.updateDamageValue(this, 'minor')">

     <button class="damage-btn" id="major-damage-btn">
      <span>Major</span>
      <span>Damage</span>
     </button>
     <input type="number" class="damage-value-input" id="major-damage-value" min="0" onchange="window.updateDamageValue(this, 'major')">

     <button class="damage-btn" id="severe-damage-btn">
      <span>Severe</span>
      <span>Damage</span>
     </button>
    </div>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-hp">-</button>
     <div class="trackers" id="hp-tracker">
      </div>
     <button class="tracker-btn add-hp">+</button>
    </div>
    <div class="divider"></div>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-stress">-</button>
     <div class="trackers" id="stress-tracker">
      </div>
     <button class="tracker-btn add-stress">+</button>
    </div>
   </div>
   <div class="column section" data-id="weapons" data-color-target="active-weapons">
    <h3>Active Weapons</h3>
   </div>
   <div class="column section" data-id="armor" data-color-target="armor-section">
    <h3>Armor</h3>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-armor">-</button>
     <div class="trackers" id="armor-tracker">
      </div>
     <button class="tracker-btn add-armor">+</button>
    </div>

   </div>
  </div>

  <div class="divider"></div>

  <nav class="tabs">
   <button data-target="domain-vault-tab-content">Domain Vault</button>
   <button data-target="effects-features-tab-content">Effects & Features</button>
   <button data-target="equipment-tab-content">Equipment</button>
   <button data-target="details-tab-content">Details</button>
   <button data-target="experiences-tab-content">Experiences</button>
   <button data-target="journal-tab-content">Journal</button>
   <button data-target="downtime-tab-content" class="active">Downtime</button>
   <button data-target="characters-tab-content">Characters</button>
   <button data-target="settings-tab-content">Settings</button>
  </nav>

  <div class="divider"></div>

  <div class="tab-content-area">
   <div id="domain-vault-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Domain Vault will go here.</p>
   </div>
   <div id="effects-features-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Effects & Features will go here.</p>
   </div>
   <div id="equipment-tab-content" class="tab-panel">
    <!-- Equipment content will be populated by equipment.js -->
   </div>
   <div id="details-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Details will go here.</p>
   </div>
   <div id="experiences-tab-content" class="tab-panel">
    <button id="show-create-experience-modal-btn" class="button" onclick="window.showCreateExperienceModal()">Create New Experience</button>
    <div id="experiences-list-container" class="experiences-list-container">
    </div>

    <div id="experience-detail-container" class="experience-detail-container" style="display: none;">
     <h4 id="detail-experience-title"></h4>
     <p id="detail-experience-description"></p>
     <p>Modifier: <input type="number" id="detail-experience-modifier" class="mini-input" min="-2" max="2" onchange="window.updateExperienceModifier(this)"></p>
     <button class="button" onclick="window.closeExperienceDetail()">Back to Experiences</button>
    </div>
   </div>
   <div id="journal-tab-content" class="tab-panel">
    <div class="journal-category-buttons">
     <button class="button active" data-journal-category="all">All Entries</button>
     <button class="button" data-journal-category="downtime">Downtime</button>
     <button class="button" data-journal-category="combat">Combat</button>
     <button class="button" data-journal-category="exploration">Exploration</button>
     <button class="button" data-journal-category="social">Social</button>
     <button class="button" data-journal-category="other">Other</button>
    </div>
    <div id="journal-entries-list" class="journal-entries-list">
    </div>
    <div id="journal-entry-detail" class="journal-entry-detail" style="display: none;">
     <div class="journal-detail-header">
      <h4 id="journal-detail-title"></h4>
      <span id="journal-detail-date"></span>
      <span id="journal-detail-category"></span>
     </div>
     <div id="journal-detail-content" class="journal-detail-content"></div>
     <button class="button" onclick="window.closeJournalDetail()">Back to Entries</button>
    </div>
    <button class="button" onclick="window.showJournalEntryModal()">Add New Entry</button>
   </div>

   <div id="downtime-tab-content" class="tab-panel active">
    <div id="rest-type-selector">
     <h2>Choose Rest Type</h2>
     <div class="button-group">
      <button class="button" onclick="window.startRest('short')">Short Rest (1 Hour)</button>
      <button class="button" onclick="window.startRest('long')">Long Rest (6 Hours)</button>
     </div>
    </div>

    <div id="rest-options-container" style="display: none;">
     <h3 id="rest-title"></h3>
     <div class="gm-notification" id="gm-notification"></div>
     <div class="notification-area" id="downtime-notification-area"></div>
     <div id="rest-options-list" class="rest-options-list">
      </div>
     <button class="button" onclick="window.confirmRest()">Confirm Rest</button>
     <button class="button" onclick="window.resetDowntimeView()">Cancel Rest</button>

     <div id="long-rest-projects-container" class="long-term-projects" style="display: none;">
      <div class="projects-header">
       <h4>Long-Term Projects</h4>
       <div class="project-action-buttons">
        <button class="button" onclick="window.showCompletedProjects()">View Completed Projects</button>
        <button class="button" onclick="window.showActiveProjects()">View Active Projects</button>
        <button class="button" onclick="window.showCreateNewProject()">Create New Project</button>
       </div>
      </div>
      <div id="project-view-area">
       <div id="completed-projects-view" style="display: none;">
        <h5>Completed Projects</h5>
        <div id="completed-projects-list"></div>
       </div>
       <div id="active-projects-view" style="display: none;">
        <h5>Active Projects - Select one to advance</h5>
        <div id="active-projects-list"></div>
        <div id="selected-project-info" style="display: none;">
         <p>Selected: <span id="selected-project-name"></span></p>
        </div>
       </div>
       <div id="create-project-view" style="display: none;">
        <h5>Create New Project</h5>
        <input type="text" id="new-project-name" placeholder="Project Name">
        <label for="new-project-segments">Number of segments (1-12):</label>
        <input type="number" id="new-project-segments" min="1" max="12" value="4">
        <div class="modal-buttons">
         <button class="button" onclick="window.createNewProject()">Create Project</button>
         <button class="button" onclick="window.hideProjectViews()">Cancel</button>
        </div>
       </div>
      </div>
     </div>

     <div id="rest-summary-area" class="rest-summary-area" style="display: none;">
      <h4>Rest Summary</h4>
      <ul id="rest-summary-list">
       </ul>
      <button class="button" onclick="window.acknowledgeRest()">Okay</button>
     </div>
    </div>
   </div>

          <!-- SIMPLE CHARACTER MANAGEMENT TAB -->
  <div id="characters-tab-content" class="tab-panel">
    <div class="simple-character-management" style="padding: 30px; text-align: center;">
        
      <!-- Header -->
      <h2>üé≠ Character Management</h2>
      <p>Simple character saving and loading</p>
      
      <!-- Quick Actions -->
      <div style="margin: 30px 0;">
        <button class="cm-btn cm-btn-create" onclick="createNewCharacter()" style="margin: 10px;">
          ‚ûï Create New Character
        </button>
        <button class="cm-btn cm-btn-test" onclick="runDatabaseTests()" style="margin: 10px;">
          üß™ Test Database
        </button>
      </div>
      
      <!-- Characters List -->
      <div id="simple-characters-list" style="margin-top: 30px;">
        <h3>Your Characters</h3>
        <div id="simple-characters-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
          <!-- Characters will be populated here -->
        </div>
      </div>
      
    </div>
    
    <!-- Simple Characters Script -->
    <script>
      // Simple Character Manager - READ ONLY CHARACTER LIST
      async function loadSimpleCharactersList() {
        const grid = document.getElementById('simple-characters-grid');
        if (!grid) return;
        
        try {
          if (!window.zeviAPI || !window.zeviAPI.isLoggedIn()) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #999;">Please log in to view characters</div>';
            return;
          }
          
          grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #999;">Loading characters...</div>';
          
          const response = await window.zeviAPI.getCharacters();
          const characters = response.characters || [];
          
          if (characters.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #999;">No characters yet. Create your first character!</div>';
            return;
          }
          
          const charactersHtml = characters.map(char => {
            const data = char.character_data || {};
            const name = data.name || 'Unnamed Character';
            const level = data.level || 1;
            const details = data.subtitle || 'No class info';
            
            return `
              <div style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 20px;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">${name}</div>
                <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">${details}</div>
                <div style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">Level ${level}</div>
                <div style="display: flex; gap: 8px; justify-content: center;">
                  <button onclick="loadCharacter(${char.id})" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    üìÇ Load
                  </button>
                  <button onclick="deleteSimpleCharacter(${char.id}, '${name}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            `;
          }).join('');
          
          grid.innerHTML = charactersHtml;
          
        } catch (error) {
          console.error('Failed to load characters:', error);
          grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #f44;">Failed to load characters</div>';
        }
      }
      
      // Simple delete character function
      async function deleteSimpleCharacter(characterId, characterName) {
        if (!confirm(`Delete character "${characterName}"? This cannot be undone.`)) {
          return;
        }
        
        try {
          await window.zeviAPI.deleteCharacter(characterId);
          alert('‚úÖ Character deleted');
          loadSimpleCharactersList(); // Refresh list
        } catch (error) {
          console.error('Delete failed:', error);
          alert('‚ùå Failed to delete character: ' + error.message);
        }
      }
      
      // Load characters when tab is opened
      document.addEventListener('click', (e) => {
        if (e.target.getAttribute('data-target') === 'characters-tab-content') {
          setTimeout(() => {
            loadSimpleCharactersList();
          }, 100);
        }
      });
      
      // Make function globally available
      window.loadSimpleCharactersList = loadSimpleCharactersList;
    </script>
  </div>
   <div id="settings-tab-content" class="tab-panel">
    <div class="settings-container">
     <h2>Settings</h2>
     
     <!-- Accent Color Theme Section -->
     <div class="settings-section">
      <h3>Accent Color Theme</h3>
      <p>Change the color of accent elements (currently yellow) throughout the character sheet.</p>
      <div class="color-control">
       <label for="accentColorPicker">Accent Color:</label>
       <div class="color-picker-group">
        <input type="color" id="accentColorPicker" value="#ffd700">
        <div class="color-preview" id="accentColorPreview"></div>
        <button type="button" id="resetAccentColor" class="reset-btn">Reset to Default</button>
       </div>
      </div>
     </div>
     
     <!-- Glassmorphic Background Tint Section -->
     <div class="settings-section">
      <h3>Glassmorphic Background Tint</h3>
      <p>Customize the color and opacity of the glassmorphic background effect.</p>
      <div class="color-control">
       <label for="glassColorPicker">Glass Tint Color:</label>
       <div class="color-picker-group">
        <input type="color" id="glassColorPicker" value="#ffffff">
        <div class="color-preview glass-preview" id="glassColorPreview"></div>
        <button type="button" id="resetGlassColor" class="reset-btn">Reset to Default</button>
       </div>
      </div>
      <div class="slider-control">
       <label for="glassOpacitySlider">Glass Opacity:</label>
       <div class="slider-group">
        <input type="range" id="glassOpacitySlider" min="5" max="30" value="10" step="1">
        <span id="glassOpacityValue">10%</span>
       </div>
      </div>
     </div>
     
     <!-- Background Image Section -->
     <div class="settings-section">
      <h3>Background Image</h3>
      <p>Upload a custom background image for your character sheet.</p>
      <div class="file-upload-control">
       <label for="bgUpload" class="file-upload-label">
        <span class="upload-icon">üèûÔ∏è</span>
        <span class="upload-text">Choose Background Image</span>
       </label>
       <input type="file" id="bgUpload" accept="image/*" onchange="uploadBackground(event)" class="file-upload-input">
      </div>
     </div>
     
     <!-- Character Code Section -->
     <div class="settings-section">
      <h3>Character Code</h3>
      <p>A unique code representing your character's current state. Share this code to let others import your character.</p>
      <div class="character-code-control">
       <div class="code-display-group">
        <label for="characterCodeDisplay">Your Character Code:</label>
        <div class="code-display">
         <input type="text" id="characterCodeDisplay" readonly value="YWSAFHB">
         <button type="button" id="copyCodeBtn" class="copy-btn" title="Copy to clipboard">üìã</button>
        </div>
       </div>
       <div class="code-actions">
        <button type="button" id="generateCodeBtn" class="action-btn">Generate New Code</button>
        <button type="button" id="importCodeBtn" class="action-btn">Import Character</button>
       </div>
      </div>
     </div>
     
     <!-- Backpack & Encumbrance Toggle Section -->
     <div class="settings-section">
      <h3>Equipment Features</h3>
      <p>Toggle advanced equipment features like backpack selection, encumbrance tracking, and additional equipment slots.</p>
      <div class="toggle-control">
       <label for="backpackToggle" class="toggle-label">
        <input type="checkbox" id="backpackToggle" checked>
        <span class="toggle-slider"></span>
        <span class="toggle-text">Enable Backpack & Encumbrance System</span>
       </label>
       <div class="toggle-description">
        <p><strong>When enabled:</strong> Backpack selection, encumbrance tracking, attire slots, and belt/consumables slots are available.</p>
        <p><strong>When disabled:</strong> Simplified equipment view with only combat equipment and inventory management.</p>
       </div>
      </div>
     </div>
     
     <!-- Account Section -->
     <div class="settings-section">
      <h3>Account</h3>
      <p>Manage your account settings and session.</p>
      <div id="account-info" style="margin: 15px 0;">
        <!-- Account info will be populated by auth system -->
      </div>
      <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
     </div>

     <!-- Account Deletion Section -->
     <div class="settings-section danger-section">
      <h3>Account Data</h3>
      <p>Delete all account data including character information and settings.</p>
      <button type="button" id="deleteAccountBtn" class="danger-btn">Delete Account</button>
     </div>
    </div>
   </div>
   
   <!-- Character Delete Modal -->
   <div id="characterDeleteModal" class="modal">
    <div class="modal-content">
     <h3>Delete Character</h3>
     <p>Are you sure you want to delete all character data? This action cannot be undone.</p>
     <div class="modal-buttons">
      <button type="button" id="confirmCharacterDelete" class="confirm-delete-btn">Confirm Character Delete</button>
      <button type="button" id="cancelCharacterDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>
   
   <!-- Account Delete Modal -->
   <div id="accountDeleteModal" class="modal">
    <div class="modal-content">
     <h3>Delete Account</h3>
     <p>Are you sure you want to delete your entire account? This will remove all data and cannot be undone.</p>
     <div class="modal-buttons">
      <button type="button" id="confirmAccountDelete" class="confirm-delete-btn">Confirm Account Delete</button>
      <button type="button" id="cancelAccountDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>

   <!-- Character Import Modal -->
   <div id="characterImportModal" class="modal">
    <div class="modal-content">
     <h3>Import Character</h3>
     <p>Enter a character code to import character data:</p>
     <input type="text" id="importCodeInput" placeholder="Enter character code (e.g. YWSAFHB)" style="width: 100%; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
     <div class="modal-buttons">
      <button type="button" id="confirmCharacterImport" class="confirm-btn">Import Character</button>
      <button type="button" id="cancelCharacterImport" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>

  </div>
 </div>



 <div id="journal-entry-modal" class="modal-overlay">
    <div class="modal">
        <h3>New Journal Entry</h3>
        <input type="text" id="journal-entry-title-input" placeholder="Entry Title (e.g., Encounter with Goblins)">
        <select id="journal-entry-category-select">
            <option value="downtime">Downtime</option>
            <option value="combat">Combat</option>
            <option value="exploration">Exploration</option>
            <option value="social">Social</option>
            <option value="other">Other</option>
        </select>
        <textarea id="journal-entry-content-input" placeholder="What happened?"></textarea>
        <div class="modal-buttons">
            <button class="button" onclick="window.saveJournalEntry()">Save Entry</button>
            <button class="button" onclick="window.closeJournalEntryModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="prepare-choice-modal" class="modal-overlay">
    <div class="modal glassmorphic">
        <h3>Prepare</h3>
        <p>Are you preparing with a party member?</p>
        <div class="modal-buttons">
            <button class="button" onclick="window.handlePrepareWithParty(true)">Yes (Gain 2 Hope)</button>
            <button class="button" onclick="window.handlePrepareWithParty(false)">No (Gain 1 Hope)</button>
        </div>
    </div>
</div>

<div id="create-experience-modal" class="modal-overlay" style="display: none;">
    <div class="modal small-modal">
        <div class="modal-header">
            <h3>Create New Experience</h3>
            <button type="button" class="modal-close-btn" onclick="window.closeCreateExperienceModal()" title="Close">√ó</button>
        </div>
        
        <div class="modal-content">
            <div class="form-group">
                <label for="experience-title-input">Experience Title</label>
                <input type="text" id="experience-title-input" placeholder="Experience Title">
            </div>
            
            <div class="form-group">
                <label for="experience-description-input">Description</label>
                <textarea id="experience-description-input" placeholder="Describe this experience..." rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label for="experience-modifier-input">Modifier (-2 to +2)</label>
                <input type="number" id="experience-modifier-input" value="0" min="-2" max="2">
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="button primary-btn" onclick="window.saveNewExperience()">Save Experience</button>
            <button class="button" onclick="window.closeCreateExperienceModal()">Cancel</button>
        </div>
    </div>
</div>





        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        
        <!-- Core Modules -->
        <script src="core/CharacterData.js"></script>
        <script src="core/UIManager.js"></script>
        <script src="core/AppController.js"></script>

        

        
        <!-- Character Sheet Modules -->
        <script src="modules/character-sheet/hpStress.js"></script>
        <script src="modules/character-sheet/hope.js"></script>
        <script src="modules/character-sheet/downtime.js"></script>
        <script src="modules/character-sheet/journal.js"></script>
        <script src="modules/character-sheet/experiences.js"></script>
        <script src="modules/character-sheet/details.js"></script>
        <script src="modules/character-sheet/domainVault.js"></script>
        <script src="modules/character-sheet/effectsFeatures.js"></script>
        <script src="modules/character-sheet/characterNameEditor.js"></script>
        <script src="modules/character-sheet/settings.js"></script>
        
        <!-- Equipment Modules -->
        <script src="modules/equipment/equipment.js"></script>
        
        <!-- Utilities -->
        <script src="assets/js/utils/script.js"></script>
 <script>
  // Character selection removed - single character mode
  
  // Auto-save character data periodically
  setInterval(() => {
    if (window.characterManager && window.characterManager.currentCharacter) {
    }
  }, 30000); // Save every 30 seconds
  
  // Flag to prevent multiple initializations
  let indexPageInitialized = false;
  
  // Simplified initialization for single character mode
  async function initializeIndexPage() {
    if (indexPageInitialized) {
      console.log('Index page already initialized, skipping...');
      return;
    }
    
    indexPageInitialized = true;
    console.log('=== INDEX.HTML: Single character mode - initializing page ===');
    
    // Check for debug parameters
    const urlParams = new URLSearchParams(window.location.search);
    const clearStorage = urlParams.get('clear');
    
    if (clearStorage) {
      console.log('CLEAR STORAGE: Clearing all ZEVI data');
      // Clear all ZEVI related data
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.startsWith('zevi-')) {
          localStorage.removeItem(key);
        }
      });
      sessionStorage.removeItem('zevi-redirect-guard');
      console.log('Storage cleared');
    }
    
    // Initialize the app controller for single character mode
    try {
      if (!window.app) {
        console.log('Creating AppController instance...');
        window.app = new AppController();
      }
      
      if (window.app && window.app.initialize) {
        await window.app.initialize();
        console.log('‚úÖ App controller initialized successfully');
      } else {
        console.error('‚ùå AppController or initialize method not found');
      }
    } catch (error) {
      console.error('‚ùå Failed to initialize app controller:', error);
    }
    
    console.log('Single character sheet ready');
  }
  
  // Check if user has a current character loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Wait for auth system to initialize first
    setTimeout(() => {
      // Check if auth system is available and handle authentication flow
      if (window.zeviAuth) {
        // If user is logged in, proceed with character sheet
        if (window.zeviAuth.api.isLoggedIn()) {
          initializeIndexPage();
        } else {
          // Hide character sheet and show login
          document.querySelector('.glass').style.display = 'none';
          window.zeviAuth.showAuthModal();
        }
      } else {
        // Fallback: initialize normally if auth system not available
        initializeIndexPage();
      }
    }, 100); // Slightly longer delay to ensure auth is ready
  });

  // === SIMPLE SAVE/LOAD FUNCTIONS ===

  // Simple save character function
  async function saveCharacter() {
    const saveBtn = document.getElementById('save-character-btn');
    
    try {
      // Check if logged in
      if (!window.zeviAPI || !window.zeviAPI.isLoggedIn()) {
        alert('‚ùå Please log in to save your character');
        return;
      }

      // Collect current character data from the sheet
      let characterData = null;
      
      // Try to collect data via app controller
      if (window.app?.characterData?.collectAllCharacterData) {
        characterData = window.app.characterData.collectAllCharacterData();
        console.log('‚úÖ Collected data via app controller');
      } else {
        console.warn('‚ùå App controller not available, using simple data collection');
        // Fallback: collect basic data directly from DOM
        characterData = collectBasicCharacterData();
      }
      
      if (!characterData) {
        alert('‚ùå Failed to collect character data from sheet');
        return;
      }

      console.log('üíæ Collected character data:', characterData);

      // Get character name from the sheet
      const characterName = characterData.name;
      if (!characterName || characterName === 'Character Name' || characterName === 'New Character') {
        alert('‚ùå Please enter a character name before saving');
        return;
      }

      console.log('üíæ Saving character with name:', characterName);

      // Disable button and show saving state
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      // Try to find existing character with this name, or create new one
      let characterId = null;
      let existingCharacter = null;
      
      try {
        // First, try to get all characters and find one with matching name
        const response = await window.zeviAPI.getCharacters();
        existingCharacter = response.characters?.find(char => 
          char.character_data?.name === characterName
        );
        
        if (existingCharacter) {
          // Update existing character
          characterId = existingCharacter.id;
          console.log('üìù Updating existing character:', characterId, characterName);
          await window.zeviAPI.saveCharacter(characterId, characterData);
        } else {
          // Create new character
          console.log('‚ûï Creating new character:', characterName);
          const createResponse = await window.zeviAPI.createCharacter(characterName, characterData);
          characterId = createResponse.character.id;
          console.log('‚úÖ New character created with ID:', characterId);
        }
      } catch (error) {
        console.error('‚ùå Error during save/create:', error);
        throw error;
      }

      // Success feedback
      const action = existingCharacter ? 'Updated' : 'Created';
      saveBtn.textContent = `‚úÖ ${action}!`;
      setTimeout(() => {
        saveBtn.textContent = 'üíæ Save Character';
        saveBtn.disabled = false;
      }, 2000);

      console.log(`‚úÖ Character ${action.toLowerCase()} successfully:`, characterName);

    } catch (error) {
      console.error('‚ùå Save failed:', error);
      
      // Error feedback
      saveBtn.textContent = '‚ùå Save Failed';
      setTimeout(() => {
        saveBtn.textContent = 'üíæ Save Character';
        saveBtn.disabled = false;
      }, 3000);

      alert('‚ùå Save failed: ' + error.message);
    }
  }

  // Simple load character function
  async function loadCharacter(characterId) {
    try {
      console.log('üìÇ Loading character:', characterId);

      // Check if logged in
      if (!window.zeviAPI || !window.zeviAPI.isLoggedIn()) {
        alert('‚ùå Please log in to load characters');
        return;
      }

      // Get character data from API
      const response = await window.zeviAPI.getCharacter(characterId);
      const character = response.character;

      console.log('üìÇ Character data received:', character);

      // Set as current character (multiple ways to ensure it works)
      console.log('üîß Setting current character ID:', characterId);
      
      // Method 1: Via app controller
      if (window.app?.setCurrentCharacterId) {
        window.app.setCurrentCharacterId(characterId);
        console.log('‚úÖ Set via app controller');
      } else {
        console.warn('‚ùå App controller not available');
      }
      
      // Method 2: Direct localStorage backup
      localStorage.setItem('zevi-current-character-id', characterId.toString());
      console.log('‚úÖ Set via localStorage backup');
      
      // Method 3: Via characterData if available
      if (window.app?.characterData?.setCurrentCharacterId) {
        window.app.characterData.setCurrentCharacterId(characterId);
        console.log('‚úÖ Set via characterData');
      }

      // Apply data to UI
      window.app?.applyCharacterDataToUI(character.character_data);

      alert('‚úÖ Character loaded: ' + (character.character_data?.name || 'Unnamed'));

    } catch (error) {
      console.error('‚ùå Load failed:', error);
      alert('‚ùå Failed to load character: ' + error.message);
    }
  }

  // Simple create new character function
  async function createNewCharacter() {
    try {
      console.log('‚ûï Creating new character');

      // Check if logged in
      if (!window.zeviAPI || !window.zeviAPI.isLoggedIn()) {
        alert('‚ùå Please log in to create characters');
        return;
      }

      // Get character name
      const name = prompt('Enter character name:');
      if (!name) {
        console.log('Character creation cancelled');
        return;
      }

      // Create with default data
      const defaultData = {
        name: name,
        subtitle: 'Community Ancestry Class (Subclass)', 
        level: parseInt(document.getElementById('charLevel')?.textContent) || 1,
        hope: { current: 0, max: 6 },
        attributes: { might: 0, agility: 0, instinct: 0, presence: 0, knowledge: 0 },
        evasion: 10,
        damage: { minor: 1, major: 2 },
        equipment: {},
        journal: { entries: [] },
        details: {},
        experiences: [],
        downtime: { projects: [] },
        domainVault: {},
        effectsFeatures: {}
      };

      console.log('‚ûï Creating character with data:', defaultData);

      // Create character via API
      const response = await window.zeviAPI.createCharacter(name, defaultData);
      const character = response.character;

      console.log('‚úÖ Character created:', character);

      // Load the new character
      await loadCharacter(character.id);

      alert('‚úÖ New character created: ' + name);

    } catch (error) {
      console.error('‚ùå Create failed:', error);
      alert('‚ùå Failed to create character: ' + error.message);
    }
  }

  // Fallback function to collect basic character data directly from DOM
  function collectBasicCharacterData() {
    try {
      console.log('üìä Collecting basic character data from DOM...');
      
      const data = {
        // Basic character info
        name: document.querySelector('.character-name-editor')?.textContent || 'New Character',
        subtitle: document.querySelector('.subtitle')?.textContent || 'Community Ancestry Class (Subclass)',
        level: parseInt(document.getElementById('charLevel')?.textContent) || 1,
        imageUrl: document.getElementById('charImage')?.src || '',
        
        // Ability scores
        attributes: {
          might: parseInt(document.getElementById('might')?.textContent) || 0,
          agility: parseInt(document.getElementById('agility')?.textContent) || 0,
          instinct: parseInt(document.getElementById('instinct')?.textContent) || 0,
          presence: parseInt(document.getElementById('presence')?.textContent) || 0,
          knowledge: parseInt(document.getElementById('knowledge')?.textContent) || 0
        },
        
        // Combat stats
        evasion: parseInt(document.getElementById('evasionValue')?.textContent) || 10,
        damage: {
          minor: parseInt(document.getElementById('minor-damage-value')?.value) || 1,
          major: parseInt(document.getElementById('major-damage-value')?.value) || 2
        },
        
        // Basic defaults for other data
        hope: { current: 0, max: 6 },
        hp: { circles: Array(4).fill({active: true}) },
        stress: { circles: Array(4).fill({active: false}) },
        armor: { circles: Array(4).fill({active: false}), totalCircles: 4, activeCount: 0 },
        equipment: {},
        journal: { entries: [] },
        details: {},
        experiences: [],
        downtime: { projects: [] },
        domainVault: {},
        effectsFeatures: {},
        
        lastModified: new Date().toISOString(),
        version: '2.0'
      };
      
      console.log('‚úÖ Basic character data collected:', data);
      return data;
      
    } catch (error) {
      console.error('‚ùå Error collecting basic character data:', error);
      return null;
    }
  }

  // Debug function to check current character sheet data
  function debugCurrentCharacter() {
    console.log('üîç === CURRENT CHARACTER SHEET DEBUG ===');
    
    // Try to get current character data from the sheet
    let characterData = null;
    let dataSource = '';
    
    if (window.app?.characterData?.collectAllCharacterData) {
      characterData = window.app.characterData.collectAllCharacterData();
      dataSource = 'App Controller';
    } else {
      characterData = collectBasicCharacterData();
      dataSource = 'DOM Fallback';
    }
    
    const characterName = characterData?.name;
    
    console.log('Character Name from sheet:', characterName);
    console.log('Full character data:', characterData);
    console.log('Data source:', dataSource);
    console.log('window.app exists:', !!window.app);
    console.log('window.app.characterData exists:', !!window.app?.characterData);
    
    if (characterData) {
      alert(`Character Sheet Debug:\n\nCharacter Name: ${characterName}\nLevel: ${characterData.level}\nSubtitle: ${characterData.subtitle}\nData Source: ${dataSource}\n\nData collection: SUCCESS\nReady to save: ${characterName && characterName !== 'Character Name' ? 'YES' : 'NO (enter character name first)'}`);
    } else {
      alert('‚ùå Failed to collect character data from sheet');
    }
  }

  // Make functions globally available
  window.saveCharacter = saveCharacter;
  window.loadCharacter = loadCharacter;
  window.createNewCharacter = createNewCharacter;
  window.debugCurrentCharacter = debugCurrentCharacter;

 </script>
</html>
