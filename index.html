<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zevi Character Sheet</title>
    <!-- Cache bust: v2.0 - 2025-07-30 -->
    <link rel="stylesheet" href="assets/css/main.css">
    <!-- API and Authentication Scripts -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
</head>
<body>
 <div class="glass" data-color-target="main-glass">
  <header>
   <div class="char-img-wrapper" onclick="document.getElementById('charUpload').click();">
    <div class="char-img-border" data-color-target="char-image-border"></div>
    <img src="" alt="Character Portrait" id="charImage">
    <div class="placeholder" id="charPlaceholder">Click to add character image</div>
    <input type="file" id="charUpload" accept="image/*" style="display:none;" onchange="uploadCharacterImage(event)">
   </div>

               <div class="name-box" data-color-target="name-box">
                <div class="character-name-editor" contenteditable="true" data-placeholder="Character Name">Character Name</div>
                <div class="subtitle" contenteditable="true">Community Ancestry Class (Subclass)</div>
    <div class="domain-row">
     <span class="domain-badge" contenteditable="true">Domain 1</span>
     <span class="domain-divider">||</span>
     <span class="level-display" id="charLevel" contenteditable="true">5</span>
     <span class="domain-divider">||</span>
     <span class="domain-badge" contenteditable="true">Domain 2</span>
    </div>
    
    <div class="hope-tracker-inline">
     <h4>Hope</h4>
     <div class="trackers-wrapper">
      <div class="tracker-btn" id="hope-decrement">-</div>
      <div class="trackers" id="hope-tracker">
       </div>
      <div class="tracker-btn" id="hope-increment">+</div>
     </div>
     <div id="encumbrance-warning-main" class="encumbrance-warning" style="display: none; margin-top: 10px; font-size: 0.8rem;"></div>
    </div>
   </div>

   <div class="right-info">
    <span id="toggleTheme" style="cursor: pointer;">üåô</span><br />
   </div>
   
   <div class="header-bottom-center">
    <a href="https://drive.google.com/file/d/1KPD_jt2jaNn2Okd9dDbQNRVdk5PAk2R2/view?usp=drivesdk" target="_blank" class="rulebook-link">Official Rulebook</a>
   </div>
  </header>

  <div class="divider"></div>

  <div class="flex-row" id="draggable-sections">
   <div class="column section" data-id="ability" data-color-target="ability-scores">
    <h3>Ability Scores</h3>
    <div class="attributes-grid">
     <div class="attribute-box">
      <h4>Agility</h4>
      <input type="number" class="attribute-value" data-attribute="agility" value="0">
      <p class="attribute-text">Sprint || Dodge || Leap</p>
     </div>
     <div class="attribute-box">
      <h4>Strength</h4>
      <input type="number" class="attribute-value" data-attribute="strength" value="0">
      <p class="attribute-text">Lift || Smash || Grapple</p>
     </div>
     <div class="attribute-box">
      <h4>Finesse</h4>
      <input type="number" class="attribute-value" data-attribute="finesse" value="0">
      <p class="attribute-text">Control || Hide || Tinker</p>
     </div>
     <div class="attribute-box">
      <h4>Instinct</h4>
      <input type="number" class="attribute-value" data-attribute="instinct" value="0">
      <p class="attribute-text">Perceive || Sense || Navigate</p>
     </div>
     <div class="attribute-box">
      <h4>Presence</h4>
      <input type="number" class="attribute-value" data-attribute="presence" value="0">
      <p class="attribute-text">Charm || Perform || Deceive</p>
     </div>
     <div class="attribute-box">
      <h4>Knowledge</h4>
      <input type="number" class="attribute-value" data-attribute="knowledge" value="0">
      <p class="attribute-text">Recall || Analyze || Comprehend</p>
     </div>
    </div>
    <div class="evasion-display">
     <div class="evasion-label">Evasion</div>
     <input type="number" class="evasion-value" id="evasionValue" value="10" contenteditable="true">
    </div>
   </div>
   <div class="column section" data-id="hp" data-color-target="hp-stress">
    <h3>Hit Points & Stress</h3>
    <div class="damage-control-row">
     <button class="damage-btn" id="minor-damage-btn">
      <span>Minor</span>
      <span>Damage</span>
     </button>
     <input type="number" class="damage-value-input" id="minor-damage-value" min="0" onchange="window.updateDamageValue(this, 'minor')">

     <button class="damage-btn" id="major-damage-btn">
      <span>Major</span>
      <span>Damage</span>
     </button>
     <input type="number" class="damage-value-input" id="major-damage-value" min="0" onchange="window.updateDamageValue(this, 'major')">

     <button class="damage-btn" id="severe-damage-btn">
      <span>Severe</span>
      <span>Damage</span>
     </button>
    </div>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-hp">-</button>
     <div class="trackers" id="hp-tracker">
      </div>
     <button class="tracker-btn add-hp">+</button>
    </div>
    <div class="divider"></div>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-stress">-</button>
     <div class="trackers" id="stress-tracker">
      </div>
     <button class="tracker-btn add-stress">+</button>
    </div>
   </div>
   <div class="column section" data-id="weapons" data-color-target="active-weapons">
    <h3>Active Weapons</h3>
   </div>
   <div class="column section" data-id="armor" data-color-target="armor-section">
    <h3>Armor</h3>
    <div class="trackers-wrapper">
     <button class="tracker-btn remove-armor">-</button>
     <div class="trackers" id="armor-tracker">
      </div>
     <button class="tracker-btn add-armor">+</button>
    </div>

   </div>
  </div>

  <div class="divider"></div>

  <nav class="tabs">
   <button data-target="domain-vault-tab-content">Domain Vault</button>
   <button data-target="effects-features-tab-content">Effects & Features</button>
   <button data-target="equipment-tab-content">Equipment</button>
   <button data-target="details-tab-content">Details</button>
   <button data-target="experiences-tab-content">Experiences</button>
   <button data-target="journal-tab-content">Journal</button>
   <button data-target="downtime-tab-content" class="active">Downtime</button>
   <button data-target="characters-tab-content">Characters</button>
   <button data-target="settings-tab-content">Settings</button>
  </nav>

  <div class="divider"></div>

  <div class="tab-content-area">
   <div id="domain-vault-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Domain Vault will go here.</p>
   </div>
   <div id="effects-features-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Effects & Features will go here.</p>
   </div>
   <div id="equipment-tab-content" class="tab-panel">
    <!-- Equipment content will be populated by equipment.js -->
   </div>
   <div id="details-tab-content" class="tab-panel">
    <p style="text-align: center;">Content for Details will go here.</p>
   </div>
   <div id="experiences-tab-content" class="tab-panel">
    <button id="show-create-experience-modal-btn" class="button" onclick="window.showCreateExperienceModal()">Create New Experience</button>
    <div id="experiences-list-container" class="experiences-list-container">
    </div>

    <div id="experience-detail-container" class="experience-detail-container" style="display: none;">
     <h4 id="detail-experience-title"></h4>
     <p id="detail-experience-description"></p>
     <p>Modifier: <input type="number" id="detail-experience-modifier" class="mini-input" min="-2" max="2" onchange="window.updateExperienceModifier(this)"></p>
     <button class="button" onclick="window.closeExperienceDetail()">Back to Experiences</button>
    </div>
   </div>
   <div id="journal-tab-content" class="tab-panel">
    <div class="journal-category-buttons">
     <button class="button active" data-journal-category="all">All Entries</button>
     <button class="button" data-journal-category="downtime">Downtime</button>
     <button class="button" data-journal-category="combat">Combat</button>
     <button class="button" data-journal-category="exploration">Exploration</button>
     <button class="button" data-journal-category="social">Social</button>
     <button class="button" data-journal-category="other">Other</button>
    </div>
    <div id="journal-entries-list" class="journal-entries-list">
    </div>
    <div id="journal-entry-detail" class="journal-entry-detail" style="display: none;">
     <div class="journal-detail-header">
      <h4 id="journal-detail-title"></h4>
      <span id="journal-detail-date"></span>
      <span id="journal-detail-category"></span>
     </div>
     <div id="journal-detail-content" class="journal-detail-content"></div>
     <button class="button" onclick="window.closeJournalDetail()">Back to Entries</button>
    </div>
    <button class="button" onclick="window.showJournalEntryModal()">Add New Entry</button>
   </div>

   <div id="downtime-tab-content" class="tab-panel active">
    <div id="rest-type-selector">
     <h2>Choose Rest Type</h2>
     <div class="button-group">
      <button class="button" onclick="window.startRest('short')">Short Rest (1 Hour)</button>
      <button class="button" onclick="window.startRest('long')">Long Rest (6 Hours)</button>
     </div>
    </div>

    <div id="rest-options-container" style="display: none;">
     <h3 id="rest-title"></h3>
     <div class="gm-notification" id="gm-notification"></div>
     <div class="notification-area" id="downtime-notification-area"></div>
     <div id="rest-options-list" class="rest-options-list">
      </div>
     <button class="button" onclick="window.confirmRest()">Confirm Rest</button>
     <button class="button" onclick="window.resetDowntimeView()">Cancel Rest</button>

     <div id="long-rest-projects-container" class="long-term-projects" style="display: none;">
      <div class="projects-header">
       <h4>Long-Term Projects</h4>
       <div class="project-action-buttons">
        <button class="button" onclick="window.showCompletedProjects()">View Completed Projects</button>
        <button class="button" onclick="window.showActiveProjects()">View Active Projects</button>
        <button class="button" onclick="window.showCreateNewProject()">Create New Project</button>
       </div>
      </div>
      <div id="project-view-area">
       <div id="completed-projects-view" style="display: none;">
        <h5>Completed Projects</h5>
        <div id="completed-projects-list"></div>
       </div>
       <div id="active-projects-view" style="display: none;">
        <h5>Active Projects - Select one to advance</h5>
        <div id="active-projects-list"></div>
        <div id="selected-project-info" style="display: none;">
         <p>Selected: <span id="selected-project-name"></span></p>
        </div>
       </div>
       <div id="create-project-view" style="display: none;">
        <h5>Create New Project</h5>
        <input type="text" id="new-project-name" placeholder="Project Name">
        <label for="new-project-segments">Number of segments (1-12):</label>
        <input type="number" id="new-project-segments" min="1" max="12" value="4">
        <div class="modal-buttons">
         <button class="button" onclick="window.createNewProject()">Create Project</button>
         <button class="button" onclick="window.hideProjectViews()">Cancel</button>
        </div>
       </div>
      </div>
     </div>

     <div id="rest-summary-area" class="rest-summary-area" style="display: none;">
      <h4>Rest Summary</h4>
      <ul id="rest-summary-list">
       </ul>
      <button class="button" onclick="window.acknowledgeRest()">Okay</button>
     </div>
    </div>
   </div>

     <!-- COMPREHENSIVE CHARACTER MANAGEMENT TAB -->
  <div id="characters-tab-content" class="tab-panel">
    <div class="character-management-container">
      
      <!-- Header -->
      <div class="cm-header">
        <h2>Character Management</h2>
        <p>Save, create, and manage your characters in the cloud</p>
      </div>
      
      <!-- Current Character Section -->
      <div class="cm-current-character glass" data-color-target="auth-modal">
        <div class="cm-current-header">
          <h3>üìã Currently Active Character</h3>
          <div class="cm-save-indicator" id="cm-save-indicator">‚óè</div>
        </div>
        
        <div class="cm-current-content" id="cm-current-content">
          <div class="cm-current-avatar" id="cm-current-avatar">?</div>
          <div class="cm-current-info">
            <div class="cm-current-name" id="cm-current-name">No Character Loaded</div>
            <div class="cm-current-details" id="cm-current-details">Create or select a character to get started</div>
            <div class="cm-current-meta">
              <span class="cm-current-level" id="cm-current-level">Level -</span>
              <span class="cm-current-saved" id="cm-current-saved">Not saved</span>
            </div>
          </div>
          <div class="cm-current-actions">
            <button class="cm-btn cm-btn-primary" id="cm-save-current" onclick="saveCurrentCharacter()">
              üíæ Save Current
            </button>
            <button class="cm-btn cm-btn-secondary" id="cm-autosave-toggle" onclick="toggleAutoSave()">
              üîÑ Auto-Save: ON
            </button>
          </div>
        </div>
      </div>
      
             <!-- Quick Actions -->
       <div class="cm-quick-actions">
         <button class="cm-btn cm-btn-create" onclick="createNewCharacter()">
           ‚ûï Create New Character
         </button>
         <button class="cm-btn cm-btn-import" onclick="importCharacter()">
           üì• Import Character
         </button>
         <button class="cm-btn cm-btn-export" onclick="exportCurrentCharacter()">
           üì§ Export Current
         </button>
         <button class="cm-btn cm-btn-test" onclick="runDatabaseTests()" title="Test database connection and data integrity (Ctrl+Shift+T)">
           üß™ Test Database
         </button>
       </div>
      
      <!-- Character List -->
      <div class="cm-character-list glass" data-color-target="equipment-glass">
        <div class="cm-list-header">
          <h3>Your Characters</h3>
          <div class="cm-list-actions">
            <button class="cm-btn cm-btn-small" onclick="refreshCharacterList()">üîÑ Refresh</button>
            <select class="cm-sort-select" id="cm-sort-select" onchange="sortCharacterList()">
              <option value="updated">Recently Updated</option>
              <option value="created">Recently Created</option>
              <option value="name">Name (A-Z)</option>
              <option value="level">Level</option>
            </select>
          </div>
        </div>
        
        <div class="cm-characters-grid" id="cm-characters-grid">
          <div class="cm-loading">
            <div class="cm-loading-icon">‚è≥</div>
            <div>Loading your characters...</div>
          </div>
        </div>
      </div>
      
      <!-- Status Bar -->
      <div class="cm-status-bar" id="cm-status-bar">
        <div class="cm-status-content">
          <span class="cm-status-icon" id="cm-status-icon">üí°</span>
          <span class="cm-status-text" id="cm-status-text">Ready to manage your characters</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Character Management Styles -->
  <style>
    .character-management-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .cm-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .cm-header h2 {
      color: var(--text-color);
      margin: 0 0 8px 0;
      font-size: 2.2rem;
    }

    .cm-header p {
      color: rgba(255,255,255,0.8);
      margin: 0;
      font-size: 1.1rem;
    }

    .cm-current-character {
      padding: 20px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.1);
    }

    .cm-current-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .cm-current-header h3 {
      color: var(--text-color);
      margin: 0;
      font-size: 1.3rem;
    }

    .cm-save-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse 2s infinite;
    }

    .cm-save-indicator.saving {
      background: #FF9800;
    }

    .cm-save-indicator.error {
      background: #f44336;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .cm-current-content {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .cm-current-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-color), rgba(255,255,255,0.3));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }

    .cm-current-info {
      flex: 1;
      min-width: 200px;
    }

    .cm-current-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 5px;
    }

    .cm-current-details {
      color: rgba(255,255,255,0.8);
      margin-bottom: 8px;
    }

    .cm-current-meta {
      display: flex;
      gap: 15px;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
    }

    .cm-current-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }

    .cm-quick-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .cm-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .cm-btn-primary {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }

    .cm-btn-secondary {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }

    .cm-btn-create {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2);
      color: white;
      padding: 15px 30px;
      font-size: 1.1rem;
    }

    .cm-btn-import {
      background: linear-gradient(135deg, #FF9800, #F57C00);
      color: white;
    }

    .cm-btn-export {
      background: linear-gradient(135deg, #607D8B, #455A64);
      color: white;
    }

    .cm-btn-test {
      background: linear-gradient(135deg, #E91E63, #C2185B);
      color: white;
    }

    .cm-btn-small {
      padding: 8px 12px;
      font-size: 0.9rem;
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
    }

    .cm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .cm-character-list {
      padding: 20px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.1);
    }

    .cm-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .cm-list-header h3 {
      color: var(--text-color);
      margin: 0;
      font-size: 1.3rem;
    }

    .cm-list-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .cm-sort-select {
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      font-size: 0.9rem;
    }

    .cm-characters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      min-height: 150px;
    }

    .cm-loading {
      grid-column: 1 / -1;
      text-align: center;
      color: rgba(255,255,255,0.7);
      padding: 40px;
    }

    .cm-loading-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .cm-character-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .cm-character-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border-color: var(--accent-color);
    }

    .cm-character-card.active {
      border-color: var(--accent-color);
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
    }

    .cm-character-card.active::before {
      content: "ACTIVE";
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--accent-color);
      color: black;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .cm-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .cm-card-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-color), rgba(255,255,255,0.3));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }

    .cm-card-info {
      flex: 1;
    }

    .cm-card-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 5px;
    }

    .cm-card-details {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
    }

    .cm-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
    }

    .cm-card-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .cm-card-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .cm-card-btn-load {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }

    .cm-card-btn-copy {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }

    .cm-card-btn-delete {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
    }

    .cm-card-btn:hover {
      transform: scale(1.05);
    }

    .cm-status-bar {
      background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
      padding: 15px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .cm-status-content {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .cm-status-icon {
      font-size: 1.2rem;
    }

    .cm-status-text {
      color: var(--text-color);
      font-weight: 500;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .character-management-container {
        padding: 15px;
      }
      
      .cm-current-content {
        flex-direction: column;
        text-align: center;
      }
      
      .cm-quick-actions {
        flex-direction: column;
      }
      
      .cm-list-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .cm-characters-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
      
    </div>
    
    <!-- Event Handlers -->
    <script>
      // Attach event listeners when the tab is visible
      document.addEventListener('DOMContentLoaded', function() {
        const saveBtn = document.getElementById('new-save-btn');
        const createBtn = document.getElementById('new-create-btn');
        const status = document.getElementById('save-status');
        
        // Save button handler
        if (saveBtn) {
          saveBtn.addEventListener('click', function() {
            console.log('üéØ NEW SAVE BUTTON CLICKED!');
            
            status.innerHTML = 'üîÑ Saving character data...';
            status.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
            
            // Test if save function exists and call it
            if (window.zeviAuth && typeof window.zeviAuth.saveCurrentCharacterData === 'function') {
              console.log('‚úÖ Calling zeviAuth.saveCurrentCharacterData()');
              
              window.zeviAuth.saveCurrentCharacterData()
                .then(() => {
                  status.innerHTML = '‚úÖ Character saved successfully!';
                  status.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                  loadNewCharactersList();
                })
                .catch(error => {
                  console.error('Save error:', error);
                  status.innerHTML = '‚ùå Save failed: ' + error.message;
                  status.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
                });
            } else {
              console.error('zeviAuth.saveCurrentCharacterData not available');
              status.innerHTML = '‚ùå Save system not available';
              status.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
            }
          });
          
          // Button hover effects
          saveBtn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
          });
          
          saveBtn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 6px 20px rgba(76, 175, 80, 0.3)';
          });
        }
        
        // Create button handler
        if (createBtn) {
          createBtn.addEventListener('click', function() {
            console.log('üéØ NEW CREATE BUTTON CLICKED!');
            
            status.innerHTML = 'üîÑ Creating new character...';
            status.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
            
            if (window.zeviAuth && typeof window.zeviAuth.createNewCharacter === 'function') {
              window.zeviAuth.createNewCharacter(true);
              setTimeout(() => {
                status.innerHTML = '‚úÖ New character created!';
                status.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                loadNewCharactersList();
              }, 1000);
            } else {
              status.innerHTML = '‚ùå Create system not available';
              status.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
            }
          });
          
          // Button hover effects
          createBtn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 10px 30px rgba(33, 150, 243, 0.4)';
          });
          
          createBtn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 6px 20px rgba(33, 150, 243, 0.3)';
          });
        }
        
        // Load characters list
        function loadNewCharactersList() {
          const grid = document.getElementById('new-characters-grid');
          if (window.zeviAuth && typeof window.zeviAuth.loadCharactersList === 'function') {
            console.log('üìã Loading characters list...');
            window.zeviAuth.loadCharactersList();
          } else {
            grid.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px; grid-column: 1 / -1;"><div style="font-size: 2rem; margin-bottom: 10px;">‚ùå</div><div>Characters system not available</div></div>';
          }
        }
            });

      // Initialize character manager when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        if (window.characterManager) {
          characterManager.init();
        }
      });
    </script>

    <!-- Character Management JavaScript -->
    <script>
      // Character Management System
      class CharacterManager {
        constructor() {
          this.isAutoSaveEnabled = true;
          this.characters = [];
          this.currentCharacterId = null;
          this.sortMethod = 'updated';
        }

        init() {
          console.log('üöÄ Initializing Character Manager');
          
          // Set up event listeners when tab is opened
          document.addEventListener('click', (e) => {
            if (e.target.getAttribute('data-target') === 'characters-tab-content') {
              setTimeout(() => {
                this.loadCurrentCharacterDisplay();
                this.loadCharactersList();
              }, 100);
            }
          });
        }

        updateStatus(text, icon = 'üí°', type = 'info') {
          const statusIcon = document.getElementById('cm-status-icon');
          const statusText = document.getElementById('cm-status-text');
          
          if (statusIcon) statusIcon.textContent = icon;
          if (statusText) statusText.textContent = text;
          
          // Update save indicator
          const saveIndicator = document.getElementById('cm-save-indicator');
          if (saveIndicator) {
            saveIndicator.className = 'cm-save-indicator';
            if (type === 'saving') saveIndicator.classList.add('saving');
            if (type === 'error') saveIndicator.classList.add('error');
          }
        }

        async loadCurrentCharacterDisplay() {
          const nameEl = document.getElementById('cm-current-name');
          const detailsEl = document.getElementById('cm-current-details');
          const levelEl = document.getElementById('cm-current-level');
          const savedEl = document.getElementById('cm-current-saved');
          const avatarEl = document.getElementById('cm-current-avatar');
          
          if (!nameEl) return;
          
          try {
            if (window.zeviAPI && window.zeviAPI.isLoggedIn()) {
              const response = await window.zeviAPI.getActiveCharacter();
              const character = response.character;
              const data = character.character_data || {};
              
              this.currentCharacterId = character.id;
              
              // Update display
              nameEl.textContent = data.name || 'Unnamed Character';
              detailsEl.textContent = [data.ancestry, data.class, data.subclass].filter(Boolean).join(' ') || 'No class info';
              levelEl.textContent = `Level ${data.level || 1}`;
              savedEl.textContent = `Last saved: ${new Date(character.updated_at).toLocaleDateString()}`;
              avatarEl.textContent = (data.name || 'U').charAt(0).toUpperCase();
              
              this.updateStatus('Active character loaded', '‚úÖ', 'success');
            } else {
              // Not logged in
              nameEl.textContent = 'Not Logged In';
              detailsEl.textContent = 'Please log in to manage characters';
              levelEl.textContent = 'Level -';
              savedEl.textContent = 'Not saved';
              avatarEl.textContent = '?';
              
              this.updateStatus('Please log in to manage characters', 'üîê', 'info');
            }
          } catch (error) {
            console.error('Failed to load current character:', error);
            nameEl.textContent = 'No Character Selected';
            detailsEl.textContent = 'Create or select a character to begin';
            levelEl.textContent = 'Level -';
            savedEl.textContent = 'Not saved';
            avatarEl.textContent = '?';
            
            this.updateStatus('No active character found', '‚ö†Ô∏è', 'info');
          }
        }

        async loadCharactersList() {
          const grid = document.getElementById('cm-characters-grid');
          if (!grid) return;
          
          if (!window.zeviAPI || !window.zeviAPI.isLoggedIn()) {
            grid.innerHTML = `
              <div class="cm-loading">
                <div class="cm-loading-icon">üîê</div>
                <div>Please log in to view your characters</div>
              </div>
            `;
            return;
          }
          
          // Show loading
          grid.innerHTML = `
            <div class="cm-loading">
              <div class="cm-loading-icon">‚è≥</div>
              <div>Loading your characters...</div>
            </div>
          `;
          
          try {
            const response = await window.zeviAPI.getCharacters();
            this.characters = response.characters || [];
            this.currentCharacterId = response.activeCharacterId;
            
            this.renderCharactersList();
            this.updateStatus(`Loaded ${this.characters.length} characters`, 'üìã', 'success');
          } catch (error) {
            console.error('Failed to load characters:', error);
            grid.innerHTML = `
              <div class="cm-loading">
                <div class="cm-loading-icon">‚ùå</div>
                <div>Failed to load characters: ${error.message}</div>
              </div>
            `;
            this.updateStatus('Failed to load characters', '‚ùå', 'error');
          }
        }

        renderCharactersList() {
          const grid = document.getElementById('cm-characters-grid');
          if (!grid) return;
          
          if (this.characters.length === 0) {
            grid.innerHTML = `
              <div class="cm-loading">
                <div class="cm-loading-icon">üìã</div>
                <div>No characters yet. Create your first character!</div>
              </div>
            `;
            return;
          }
          
          // Sort characters
          this.sortCharacters();
          
          const charactersHtml = this.characters.map(char => {
            const data = char.character_data || {};
            const isActive = char.id.toString() === this.currentCharacterId?.toString();
            const avatar = (data.name || 'U').charAt(0).toUpperCase();
            const details = [data.ancestry, data.class, data.subclass].filter(Boolean).join(' ') || 'No class info';
            
            return `
              <div class="cm-character-card ${isActive ? 'active' : ''}" data-character-id="${char.id}">
                <div class="cm-card-header">
                  <div class="cm-card-avatar">${avatar}</div>
                  <div class="cm-card-info">
                    <div class="cm-card-name">${data.name || 'Unnamed Character'}</div>
                    <div class="cm-card-details">${details}</div>
                  </div>
                </div>
                
                <div class="cm-card-meta">
                  <span>Level ${data.level || 1}</span>
                  <span>${new Date(char.updated_at).toLocaleDateString()}</span>
                </div>
                
                <div class="cm-card-actions">
                  <button class="cm-card-btn cm-card-btn-load" onclick="characterManager.loadCharacter(${char.id})">
                    üìÇ Load
                  </button>
                  <button class="cm-card-btn cm-card-btn-copy" onclick="characterManager.duplicateCharacter(${char.id})">
                    üìã Copy
                  </button>
                  <button class="cm-card-btn cm-card-btn-delete" onclick="characterManager.deleteCharacter(${char.id})">
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            `;
          }).join('');
          
          grid.innerHTML = charactersHtml;
        }

        sortCharacters() {
          switch (this.sortMethod) {
            case 'name':
              this.characters.sort((a, b) => (a.character_data?.name || 'Unnamed').localeCompare(b.character_data?.name || 'Unnamed'));
              break;
            case 'level':
              this.characters.sort((a, b) => (b.character_data?.level || 1) - (a.character_data?.level || 1));
              break;
            case 'created':
              this.characters.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              break;
            case 'updated':
            default:
              this.characters.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
              break;
          }
        }

        async loadCharacter(characterId) {
          try {
            this.updateStatus('Loading character...', 'üìÇ', 'saving');
            
            // Save current character first if logged in
            if (window.app?.characterData?.getCurrentCharacterId()) {
              await this.saveCurrentCharacter();
            }
            
            // Load the new character
            await window.app?.characterData?.loadCloudCharacter(characterId);
            
            // Update displays
            await this.loadCurrentCharacterDisplay();
            this.renderCharactersList();
            
            // Switch to main character sheet
            const downtimeTab = document.querySelector('[data-target="downtime-tab-content"]');
            if (downtimeTab) downtimeTab.click();
            
            this.updateStatus('Character loaded successfully', '‚úÖ', 'success');
          } catch (error) {
            console.error('Failed to load character:', error);
            this.updateStatus(`Failed to load character: ${error.message}`, '‚ùå', 'error');
          }
        }

        async duplicateCharacter(characterId) {
          try {
            this.updateStatus('Duplicating character...', 'üìã', 'saving');
            
            const response = await window.zeviAPI.getCharacter(characterId);
            const originalChar = response.character;
            
            const duplicatedData = {
              ...originalChar.character_data,
              name: `${originalChar.character_data?.name || 'Character'} (Copy)`,
              createdAt: new Date().toISOString()
            };
            
            await window.zeviAPI.createCharacter(duplicatedData.name, duplicatedData, false);
            
            await this.loadCharactersList();
            this.updateStatus('Character duplicated successfully', '‚úÖ', 'success');
          } catch (error) {
            console.error('Failed to duplicate character:', error);
            this.updateStatus(`Failed to duplicate character: ${error.message}`, '‚ùå', 'error');
          }
        }

        async deleteCharacter(characterId) {
          if (!confirm('Are you sure you want to delete this character? This action cannot be undone.')) {
            return;
          }
          
          try {
            this.updateStatus('Deleting character...', 'üóëÔ∏è', 'saving');
            
            await window.zeviAPI.deleteCharacter(characterId);
            
            // If we deleted the current character, clear it
            if (characterId.toString() === this.currentCharacterId?.toString()) {
              this.currentCharacterId = null;
              await this.loadCurrentCharacterDisplay();
            }
            
            await this.loadCharactersList();
            this.updateStatus('Character deleted successfully', '‚úÖ', 'success');
          } catch (error) {
            console.error('Failed to delete character:', error);
            this.updateStatus(`Failed to delete character: ${error.message}`, '‚ùå', 'error');
          }
        }
      }

      // Global character manager instance
      window.characterManager = new CharacterManager();

      // Global functions for HTML onclick handlers
      async function saveCurrentCharacter() {
        try {
          characterManager.updateStatus('Saving character...', 'üíæ', 'saving');
          
          const currentCharacterId = window.app?.characterData?.getCurrentCharacterId();
          if (!currentCharacterId) {
            throw new Error('No current character to save');
          }
          
          const characterData = window.app?.characterData?.collectCurrentCharacterData();
          if (!characterData) {
            throw new Error('Failed to collect character data');
          }
          
          await window.app.characterData.saveCharacterData(currentCharacterId, characterData, 'manual');
          
          await characterManager.loadCurrentCharacterDisplay();
          await characterManager.loadCharactersList();
          
          characterManager.updateStatus('Character saved successfully', '‚úÖ', 'success');
        } catch (error) {
          console.error('Failed to save character:', error);
          characterManager.updateStatus(`Save failed: ${error.message}`, '‚ùå', 'error');
        }
      }

      function toggleAutoSave() {
        characterManager.isAutoSaveEnabled = !characterManager.isAutoSaveEnabled;
        const btn = document.getElementById('cm-autosave-toggle');
        if (btn) {
          btn.textContent = `üîÑ Auto-Save: ${characterManager.isAutoSaveEnabled ? 'ON' : 'OFF'}`;
        }
        
        characterManager.updateStatus(
          `Auto-save ${characterManager.isAutoSaveEnabled ? 'enabled' : 'disabled'}`, 
          characterManager.isAutoSaveEnabled ? '‚úÖ' : '‚è∏Ô∏è', 
          'info'
        );
      }

      async function createNewCharacter() {
        try {
          characterManager.updateStatus('Creating new character...', '‚ûï', 'saving');
          
          // Save current character first if logged in
          if (window.app?.characterData?.getCurrentCharacterId()) {
            await characterManager.saveCurrentCharacter();
          }
          
          // Create new character
          const defaultData = window.app?.characterData?.createDefaultState() || {};
          const response = await window.zeviAPI.createCharacter('New Character', defaultData, true);
          
          // Load the new character
          await characterManager.loadCharacter(response.character.id);
          
          characterManager.updateStatus('New character created', '‚úÖ', 'success');
        } catch (error) {
          console.error('Failed to create character:', error);
          characterManager.updateStatus(`Failed to create character: ${error.message}`, '‚ùå', 'error');
        }
      }

      function importCharacter() {
        characterManager.updateStatus('Import feature coming soon', 'üöß', 'info');
      }

      function exportCurrentCharacter() {
        characterManager.updateStatus('Export feature coming soon', 'üöß', 'info');
      }

      function refreshCharacterList() {
        characterManager.loadCharactersList();
      }

      function sortCharacterList() {
        const select = document.getElementById('cm-sort-select');
        if (select) {
          characterManager.sortMethod = select.value;
          characterManager.renderCharactersList();
        }
      }

      // Testing functions for database verification
      async function runDatabaseTests() {
        const statusEl = document.getElementById('cm-status-text');
        const iconEl = document.getElementById('cm-status-icon');
        
        if (!window.zeviAPI || !window.zeviAPI.isLoggedIn()) {
          characterManager.updateStatus('Must be logged in to run tests', 'üîê', 'error');
          return;
        }
        
        characterManager.updateStatus('Running database tests...', 'üß™', 'saving');
        
        try {
          // Test 1: Database Connection
          iconEl.textContent = 'üîå';
          statusEl.textContent = 'Testing database connection...';
          const connectionTest = await window.zeviAPI.testDatabaseConnection();
          console.log('‚úÖ Database connection test:', connectionTest);
          
          // Test 2: Character Save/Load
          iconEl.textContent = 'üíæ';
          statusEl.textContent = 'Testing character save/load cycle...';
          const saveTest = await window.zeviAPI.testCharacterSave({
            testField: 'Database test at ' + new Date().toISOString()
          });
          console.log('‚úÖ Character save test:', saveTest);
          
          // Test 3: User Characters
          iconEl.textContent = 'üë§';
          statusEl.textContent = 'Testing user character data...';
          const userTest = await window.zeviAPI.testUserCharacters();
          console.log('‚úÖ User characters test:', userTest);
          
          // Test 4: Database Schema
          iconEl.textContent = 'üìã';
          statusEl.textContent = 'Testing database schema...';
          const schemaTest = await window.zeviAPI.testDatabaseSchema();
          console.log('‚úÖ Database schema test:', schemaTest);
          
          // Show results
          const results = {
            connection: connectionTest.status === 'success',
            saveLoad: saveTest.status === 'success',
            userData: userTest.status === 'success',
            schema: schemaTest.status === 'success'
          };
          
          const allPassed = Object.values(results).every(test => test);
          
          characterManager.updateStatus(
            `Database tests ${allPassed ? 'PASSED' : 'FAILED'} (${Object.values(results).filter(Boolean).length}/4)`,
            allPassed ? '‚úÖ' : '‚ö†Ô∏è',
            allPassed ? 'success' : 'error'
          );
          
          // Show detailed results in console
          console.group('üß™ Database Test Results');
          console.log('Connection Test:', connectionTest);
          console.log('Save/Load Test:', saveTest);
          console.log('User Data Test:', userTest);
          console.log('Schema Test:', schemaTest);
          console.log('Summary:', results);
          console.groupEnd();
          
          // Optionally show alert with summary
          if (allPassed) {
            alert('‚úÖ All database tests passed!\n\n' +
              `‚Ä¢ Database connection: Working\n` +
              `‚Ä¢ Character save/load: Working\n` +
              `‚Ä¢ User data integrity: Working\n` +
              `‚Ä¢ Database schema: Valid\n\n` +
              `Your character data is being saved properly to Neon database!`);
          } else {
            alert('‚ö†Ô∏è Some database tests failed!\n\n' +
              `‚Ä¢ Database connection: ${results.connection ? '‚úÖ' : '‚ùå'}\n` +
              `‚Ä¢ Character save/load: ${results.saveLoad ? '‚úÖ' : '‚ùå'}\n` +
              `‚Ä¢ User data integrity: ${results.userData ? '‚úÖ' : '‚ùå'}\n` +
              `‚Ä¢ Database schema: ${results.schema ? '‚úÖ' : '‚ùå'}\n\n` +
              `Check the console for detailed error information.`);
          }
          
        } catch (error) {
          console.error('‚ùå Database tests failed:', error);
          characterManager.updateStatus(`Tests failed: ${error.message}`, '‚ùå', 'error');
          alert('‚ùå Database tests failed!\n\n' + error.message + '\n\nCheck the console for details.');
        }
      }

      // Add keyboard shortcut for testing
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
          e.preventDefault();
          runDatabaseTests();
        }
      });
    </script>
  </div>
   <div id="settings-tab-content" class="tab-panel">
    <div class="settings-container">
     <h2>Settings</h2>
     
     <!-- Accent Color Theme Section -->
     <div class="settings-section">
      <h3>Accent Color Theme</h3>
      <p>Change the color of accent elements (currently yellow) throughout the character sheet.</p>
      <div class="color-control">
       <label for="accentColorPicker">Accent Color:</label>
       <div class="color-picker-group">
        <input type="color" id="accentColorPicker" value="#ffd700">
        <div class="color-preview" id="accentColorPreview"></div>
        <button type="button" id="resetAccentColor" class="reset-btn">Reset to Default</button>
       </div>
      </div>
     </div>
     
     <!-- Glassmorphic Background Tint Section -->
     <div class="settings-section">
      <h3>Glassmorphic Background Tint</h3>
      <p>Customize the color and opacity of the glassmorphic background effect.</p>
      <div class="color-control">
       <label for="glassColorPicker">Glass Tint Color:</label>
       <div class="color-picker-group">
        <input type="color" id="glassColorPicker" value="#ffffff">
        <div class="color-preview glass-preview" id="glassColorPreview"></div>
        <button type="button" id="resetGlassColor" class="reset-btn">Reset to Default</button>
       </div>
      </div>
      <div class="slider-control">
       <label for="glassOpacitySlider">Glass Opacity:</label>
       <div class="slider-group">
        <input type="range" id="glassOpacitySlider" min="5" max="30" value="10" step="1">
        <span id="glassOpacityValue">10%</span>
       </div>
      </div>
     </div>
     
     <!-- Background Image Section -->
     <div class="settings-section">
      <h3>Background Image</h3>
      <p>Upload a custom background image for your character sheet.</p>
      <div class="file-upload-control">
       <label for="bgUpload" class="file-upload-label">
        <span class="upload-icon">üèûÔ∏è</span>
        <span class="upload-text">Choose Background Image</span>
       </label>
       <input type="file" id="bgUpload" accept="image/*" onchange="uploadBackground(event)" class="file-upload-input">
      </div>
     </div>
     
     <!-- Character Code Section -->
     <div class="settings-section">
      <h3>Character Code</h3>
      <p>A unique code representing your character's current state. Share this code to let others import your character.</p>
      <div class="character-code-control">
       <div class="code-display-group">
        <label for="characterCodeDisplay">Your Character Code:</label>
        <div class="code-display">
         <input type="text" id="characterCodeDisplay" readonly value="YWSAFHB">
         <button type="button" id="copyCodeBtn" class="copy-btn" title="Copy to clipboard">üìã</button>
        </div>
       </div>
       <div class="code-actions">
        <button type="button" id="generateCodeBtn" class="action-btn">Generate New Code</button>
        <button type="button" id="importCodeBtn" class="action-btn">Import Character</button>
       </div>
      </div>
     </div>
     
     <!-- Backpack & Encumbrance Toggle Section -->
     <div class="settings-section">
      <h3>Equipment Features</h3>
      <p>Toggle advanced equipment features like backpack selection, encumbrance tracking, and additional equipment slots.</p>
      <div class="toggle-control">
       <label for="backpackToggle" class="toggle-label">
        <input type="checkbox" id="backpackToggle" checked>
        <span class="toggle-slider"></span>
        <span class="toggle-text">Enable Backpack & Encumbrance System</span>
       </label>
       <div class="toggle-description">
        <p><strong>When enabled:</strong> Backpack selection, encumbrance tracking, attire slots, and belt/consumables slots are available.</p>
        <p><strong>When disabled:</strong> Simplified equipment view with only combat equipment and inventory management.</p>
       </div>
      </div>
     </div>
     
     <!-- Account Section -->
     <div class="settings-section">
      <h3>Account</h3>
      <p>Manage your account settings and session.</p>
      <div id="account-info" style="margin: 15px 0;">
        <!-- Account info will be populated by auth system -->
      </div>
      <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
     </div>

     <!-- Account Deletion Section -->
     <div class="settings-section danger-section">
      <h3>Account Data</h3>
      <p>Delete all account data including character information and settings.</p>
      <button type="button" id="deleteAccountBtn" class="danger-btn">Delete Account</button>
     </div>
    </div>
   </div>
   
   <!-- Character Delete Modal -->
   <div id="characterDeleteModal" class="modal">
    <div class="modal-content">
     <h3>Delete Character</h3>
     <p>Are you sure you want to delete all character data? This action cannot be undone.</p>
     <div class="modal-buttons">
      <button type="button" id="confirmCharacterDelete" class="confirm-delete-btn">Confirm Character Delete</button>
      <button type="button" id="cancelCharacterDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>
   
   <!-- Account Delete Modal -->
   <div id="accountDeleteModal" class="modal">
    <div class="modal-content">
     <h3>Delete Account</h3>
     <p>Are you sure you want to delete your entire account? This will remove all data and cannot be undone.</p>
     <div class="modal-buttons">
      <button type="button" id="confirmAccountDelete" class="confirm-delete-btn">Confirm Account Delete</button>
      <button type="button" id="cancelAccountDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>

   <!-- Character Import Modal -->
   <div id="characterImportModal" class="modal">
    <div class="modal-content">
     <h3>Import Character</h3>
     <p>Enter a character code to import character data:</p>
     <input type="text" id="importCodeInput" placeholder="Enter character code (e.g. YWSAFHB)" style="width: 100%; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
     <div class="modal-buttons">
      <button type="button" id="confirmCharacterImport" class="confirm-btn">Import Character</button>
      <button type="button" id="cancelCharacterImport" class="cancel-btn">Cancel</button>
     </div>
    </div>
   </div>

  </div>
 </div>



 <div id="journal-entry-modal" class="modal-overlay">
    <div class="modal">
        <h3>New Journal Entry</h3>
        <input type="text" id="journal-entry-title-input" placeholder="Entry Title (e.g., Encounter with Goblins)">
        <select id="journal-entry-category-select">
            <option value="downtime">Downtime</option>
            <option value="combat">Combat</option>
            <option value="exploration">Exploration</option>
            <option value="social">Social</option>
            <option value="other">Other</option>
        </select>
        <textarea id="journal-entry-content-input" placeholder="What happened?"></textarea>
        <div class="modal-buttons">
            <button class="button" onclick="window.saveJournalEntry()">Save Entry</button>
            <button class="button" onclick="window.closeJournalEntryModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="prepare-choice-modal" class="modal-overlay">
    <div class="modal glassmorphic">
        <h3>Prepare</h3>
        <p>Are you preparing with a party member?</p>
        <div class="modal-buttons">
            <button class="button" onclick="window.handlePrepareWithParty(true)">Yes (Gain 2 Hope)</button>
            <button class="button" onclick="window.handlePrepareWithParty(false)">No (Gain 1 Hope)</button>
        </div>
    </div>
</div>

<div id="create-experience-modal" class="modal-overlay" style="display: none;">
    <div class="modal small-modal">
        <div class="modal-header">
            <h3>Create New Experience</h3>
            <button type="button" class="modal-close-btn" onclick="window.closeCreateExperienceModal()" title="Close">√ó</button>
        </div>
        
        <div class="modal-content">
            <div class="form-group">
                <label for="experience-title-input">Experience Title</label>
                <input type="text" id="experience-title-input" placeholder="Experience Title">
            </div>
            
            <div class="form-group">
                <label for="experience-description-input">Description</label>
                <textarea id="experience-description-input" placeholder="Describe this experience..." rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label for="experience-modifier-input">Modifier (-2 to +2)</label>
                <input type="number" id="experience-modifier-input" value="0" min="-2" max="2">
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="button primary-btn" onclick="window.saveNewExperience()">Save Experience</button>
            <button class="button" onclick="window.closeCreateExperienceModal()">Cancel</button>
        </div>
    </div>
</div>





        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        
        <!-- Core Modules -->
        <script src="core/CharacterData.js"></script>
        <script src="core/UIManager.js"></script>
        <script src="core/AutoSave.js"></script>
        <script src="core/AppController.js"></script>
        

        
        <!-- Character Sheet Modules -->
        <script src="modules/character-sheet/hpStress.js"></script>
        <script src="modules/character-sheet/hope.js"></script>
        <script src="modules/character-sheet/downtime.js"></script>
        <script src="modules/character-sheet/journal.js"></script>
        <script src="modules/character-sheet/experiences.js"></script>
        <script src="modules/character-sheet/details.js"></script>
        <script src="modules/character-sheet/domainVault.js"></script>
        <script src="modules/character-sheet/effectsFeatures.js"></script>
        <script src="modules/character-sheet/characterNameEditor.js"></script>
        <script src="modules/character-sheet/settings.js"></script>
        
        <!-- Equipment Modules -->
        <script src="modules/equipment/equipment.js"></script>
        
        <!-- Utilities -->
        <script src="assets/js/utils/script.js"></script>
 <script>
  // Character selection removed - single character mode
  
  // Auto-save character data periodically
  setInterval(() => {
    if (window.characterManager && window.characterManager.currentCharacter) {
      window.characterManager.saveCharacterData(window.characterManager.currentCharacter);
    }
  }, 30000); // Save every 30 seconds
  
  // Flag to prevent multiple initializations
  let indexPageInitialized = false;
  
  // Simplified initialization for single character mode
  function initializeIndexPage() {
    if (indexPageInitialized) {
      console.log('Index page already initialized, skipping...');
      return;
    }
    
    indexPageInitialized = true;
    console.log('=== INDEX.HTML: Single character mode - initializing page ===');
    
    // Check for debug parameters
    const urlParams = new URLSearchParams(window.location.search);
    const clearStorage = urlParams.get('clear');
    
    if (clearStorage) {
      console.log('CLEAR STORAGE: Clearing all ZEVI data');
      // Clear all ZEVI related data
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.startsWith('zevi-')) {
          localStorage.removeItem(key);
        }
      });
      sessionStorage.removeItem('zevi-redirect-guard');
      console.log('Storage cleared');
    }
    
    // Initialize the app controller for single character mode
    if (window.app && window.app.init) {
      window.app.init();
      console.log('App controller initialized');
    }
    
    console.log('Single character sheet ready');
  }
  
  // Check if user has a current character loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Wait for auth system to initialize first
    setTimeout(() => {
      // Check if auth system is available and handle authentication flow
      if (window.zeviAuth) {
        // If user is logged in, proceed with character sheet
        if (window.zeviAuth.api.isLoggedIn()) {
          initializeIndexPage();
        } else {
          // Hide character sheet and show login
          document.querySelector('.glass').style.display = 'none';
          window.zeviAuth.showAuthModal();
        }
      } else {
        // Fallback: initialize normally if auth system not available
        initializeIndexPage();
      }
    }, 100); // Slightly longer delay to ensure auth is ready
  });
 </script>
</html>
